<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.551">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Alex Skeels and Oskar Hagen">

<title>Center for Biodiversity Analysis: Gen3sis Workshop 2024 - 4&nbsp; üñ•Ô∏è Silicodiversity</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./Day2_Prac5_landscapes.html" rel="next">
<link href="./Day1_Prac3_islands.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./Day2_Prac4_outputs.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">üñ•Ô∏è Silicodiversity</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Center for Biodiversity Analysis: Gen3sis Workshop 2024</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Program</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Day1_Prac1_setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">üçç Gettin‚Äô Started</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Day1_Prac2_basics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">‚õ∏Ô∏è Configure Skating</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Day1_Prac3_islands.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">üèùÔ∏è Island Hopping</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Day2_Prac4_outputs.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">üñ•Ô∏è Silicodiversity</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Day2_Prac5_landscapes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">üåã Creating Worlds</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Day3_Prac6_sandbox.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">ü•™ Sandbox</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#exploring-outputs" id="toc-exploring-outputs" class="nav-link active" data-scroll-target="#exploring-outputs">Exploring outputs</a></li>
  <li><a href="#sensitivity-analysis" id="toc-sensitivity-analysis" class="nav-link" data-scroll-target="#sensitivity-analysis">Sensitivity analysis</a>
  <ul class="collapse">
  <li><a href="#model-selection" id="toc-model-selection" class="nav-link" data-scroll-target="#model-selection"><span class="header-section-number">4.0.1</span> Model Selection</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">üñ•Ô∏è Silicodiversity</span></h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Alex Skeels and Oskar Hagen </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="exploring-outputs" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="exploring-outputs">Exploring outputs</h2>
<p>In this practical we will explore the outputs from gen3sis using the island simulations we ran yesterday. We will learn how to use this data with common R packages for phylogenetic comparative methods, community phylogenetics, biogeography and much more.</p>
<p>The goal for today will be to produce:</p>
<ol type="1">
<li><p>A map of Species Richness from the simulation summary object</p></li>
<li><p>A plot of Lineages Through Time from the phylogeny</p></li>
<li><p>Plot of species trait values on a phylogenetic tree, by linking the species objects to the phylogeny</p></li>
<li><p>Maps of Phylogenetic Diversity by linking species objects to the landscape and phylogeny</p></li>
</ol>
<p>First, let‚Äôs make sure we have the necessary packages loaded</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(gen3sis)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(terra)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(ape)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(phytools)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(picante)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(here)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="fu">here</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="simulation-summary-object-sgen3sis.rds" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="simulation-summary-object-sgen3sis.rds">Simulation summary object (sgen3sis.rds)</h4>
<p>The first object we will look at today is the sgenesis.rds file. This file contains a summary of the simulation. Which we can plot (as we did yesterday) with the plot_summary function. This is the same object, that you would have in memory by running a simulation with run_simulation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>output_dir <span class="ot">&lt;-</span> <span class="st">"output/islands"</span> </span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>sim <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">file.path</span>(output_dir, <span class="st">"config_islands_simple_Day1Prac3_M3/sgen3sis.rds"</span>)) </span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># look at what the simulation summary contains</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(sim)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "summary"    "flag"       "system"     "parameters"</code></pre>
</div>
</div>
<p>The first element is the sim summary. This contains a record of the history of speciation, extinction, and species richness through time (phylo_summary), a history of the number of total grid cells occupied during the simulation through time (occupancy) and the species richness of each grid cell at the final time step.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(sim<span class="sc">$</span>summary)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 3
 $ phylo_summary : num [1:52, 1:4] 4 4 4 4 4 4 4 4 5 5 ...
  ..- attr(*, "dimnames")=List of 2
  .. ..$ : chr [1:52] "initial" "50" "49" "48" ...
  .. ..$ : chr [1:4] "total" "alive" "speciations" "extinctions"
 $ occupancy     : Named num [1:52] 1 0.522 0.523 0.521 0.512 ...
  ..- attr(*, "names")= chr [1:52] "initial" "50" "49" "48" ...
 $ richness-final: num [1:3600, 1:3] 0.5 1.5 2.5 3.5 4.5 5.5 6.5 7.5 8.5 9.5 ...
  ..- attr(*, "dimnames")=List of 2
  .. ..$ : chr [1:3600] "1" "2" "3" "4" ...
  .. ..$ : chr [1:3] "x" "y" "0"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># phylo summary</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(sim<span class="sc">$</span>summary<span class="sc">$</span>phylo_summary)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        total alive speciations extinctions
initial     4     4           4           0
50          4     4           0           0
49          4     4           0           0
48          4     4           0           0
47          4     4           0           0
46          4     4           0           0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># occupancy</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(sim<span class="sc">$</span>summary<span class="sc">$</span>occupancy)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  initial        50        49        48        47        46 
1.0000000 0.5215647 0.5232108 0.5211665 0.5117967 0.5004398 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># occupancy</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(sim<span class="sc">$</span>summary<span class="sc">$</span><span class="st">`</span><span class="at">richness-final</span><span class="st">`</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    x    y 0
1 0.5 59.5 0
2 1.5 59.5 0
3 2.5 59.5 0
4 3.5 59.5 0
5 4.5 59.5 0
6 5.5 59.5 0</code></pre>
</div>
</div>
<p>These data can be visualized with the plot_summary function</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the outputs </span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_summary</span>(sim)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Day2_Prac4_outputs_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can also use these data to map out patterns of species richness</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># make sure the landscape is loaded</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>lc <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">file.path</span>(<span class="st">"data"</span>, <span class="st">"landscapes"</span>, <span class="st">"islands"</span>,<span class="st">"landscapes.rds"</span>))</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co"># can remove cells with elevation below sea level at timestep 0 (present-day) to see the outlines of the islands</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>na_mask <span class="ot">&lt;-</span> <span class="fu">is.na</span>(lc<span class="sc">$</span>elevation[,<span class="st">"0"</span>])</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>rich <span class="ot">&lt;-</span> sim<span class="sc">$</span>summary<span class="sc">$</span><span class="st">`</span><span class="at">richness-final</span><span class="st">`</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>rich[na_mask,<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="co"># turn richness summary into a raster </span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>richness <span class="ot">&lt;-</span> <span class="fu">rast</span>(rich, <span class="at">type=</span><span class="st">"xyz"</span>)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="co"># plot, the sea is darblue, given by hexadecimal color code </span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(richness, <span class="at">col=</span><span class="fu">c</span>(<span class="st">"grey"</span>, gen3sis<span class="sc">::</span><span class="fu">color_richness</span>(<span class="dv">12</span>)), <span class="at">colNA=</span><span class="st">"#000033"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Day2_Prac4_outputs_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The next part of the simulation summary object is the flag which will tell us if the simulation ran successfully. It should give ‚ÄúOK‚Äù</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>sim<span class="sc">$</span>flag</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "OK"</code></pre>
</div>
</div>
<p>Next is the system summary. This is information about the R version, R packages, and operating system used in the simulation. This ensures complete repeatability. It also tells us the runtime of the simulation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>sim<span class="sc">$</span>system</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$`runtime-hours`
[1] 0.05406023

$`gen3sis-version`
[1] '1.5.11'

$`R-version`
               _                                
platform       x86_64-w64-mingw32               
arch           x86_64                           
os             mingw32                          
crt            ucrt                             
system         x86_64, mingw32                  
status                                          
major          4                                
minor          2.2                              
year           2022                             
month          10                               
day            31                               
svn rev        83211                            
language       R                                
version.string R version 4.2.2 (2022-10-31 ucrt)
nickname       Innocent and Trusting            

$OS
  sysname 
"Windows" 

$`session-information`
R version 4.2.2 (2022-10-31 ucrt)
Platform: x86_64-w64-mingw32/x64 (64-bit)
Running under: Windows 10 x64 (build 19045)

Matrix products: default

locale:
[1] LC_COLLATE=English_Australia.utf8  LC_CTYPE=English_Australia.utf8   
[3] LC_MONETARY=English_Australia.utf8 LC_NUMERIC=C                      
[5] LC_TIME=English_Australia.utf8    

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] here_1.0.1      picante_1.8.2   nlme_3.1-160    vegan_2.6-4    
 [5] lattice_0.20-45 permute_0.9-7   phytools_2.1-1  maps_3.4.1     
 [9] ape_5.7-1       terra_1.7-29    gen3sis_1.5.11 

loaded via a namespace (and not attached):
 [1] Rcpp_1.0.10             compiler_4.2.2          iterators_1.0.14       
 [4] tools_4.2.2             digest_0.6.31           lifecycle_1.0.4        
 [7] gdistance_1.6.4         mgcv_1.8-42             pkgconfig_2.0.3        
[10] rlang_1.1.3             fastmatch_1.1-3         Matrix_1.6-5           
[13] foreach_1.5.2           igraph_2.0.3            cli_3.6.0              
[16] rstudioapi_0.14         parallel_4.2.2          expm_0.999-7           
[19] xfun_0.47               coda_0.19-4.1           cluster_2.1.4          
[22] stringr_1.5.1           raster_3.6-26           knitr_1.48             
[25] vctrs_0.6.0             generics_0.1.3          rprojroot_2.0.4        
[28] scatterplot3d_0.3-44    combinat_0.0-8          grid_4.2.2             
[31] glue_1.6.2              optimParallel_1.0-2     phangorn_2.11.1        
[34] sp_2.1-4                magrittr_2.0.3          splines_4.2.2          
[37] codetools_0.2-19        MASS_7.3-58.3           mnormt_2.1.1           
[40] numDeriv_2016.8-1.1     quadprog_1.5-8          stringi_1.7.12         
[43] doParallel_1.0.17       clusterGeneration_1.3.8</code></pre>
</div>
</div>
<p>Finally the summary object contains the config information and model parameters used.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>sim<span class="sc">$</span>parameters</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$gen3sis
$gen3sis$general
$gen3sis$general$random_seed
[1] 666

$gen3sis$general$start_time
[1] 50

$gen3sis$general$end_time
[1] 0

$gen3sis$general$max_number_of_species
[1] 50000

$gen3sis$general$max_number_of_coexisting_species
[1] 20000

$gen3sis$general$end_of_timestep_observer
function(data, vars, config){  
  
  plot_richness(data$all_species, data$landscape)
  
  save_species() # saves a species and landscape objects for desired timesteps
  
}
&lt;environment: 0x00000208771f4170&gt;

$gen3sis$general$trait_names
[1] "dispersal"         "temp_niche_centre" "temp_niche_width" 
[4] "start_island"     

$gen3sis$general$environmental_ranges
list()

$gen3sis$general$verbose
[1] 1


$gen3sis$initialization
$gen3sis$initialization$initial_abundance
[1] 1

$gen3sis$initialization$create_ancestor_species
function(landscape, config) {
  # browser()
  co &lt;- landscape$coordinates
  
  # If we wouldn't have passe the patches though the environment, we could have done this:
  # sp1 &lt;- co[which(co[,1]&lt;20&amp;co[,2]&lt;30),]
  # sp2 &lt;- co[which(co[,1]&gt;20&amp;co[,2]&lt;30),]
  # sp3 &lt;- co[which(co[,1]&lt;20&amp;co[,2]&gt;30),]
  # sp4 &lt;- co[which(co[,1]&gt;20&amp;co[,2]&gt;30),]
  
  # however, we made thinks simpler to you.
  # get patches vector
  pv &lt;- landscape$environment[, "patch"]
  
  # species_coords &lt;- list(sp1,
  #                        sp2,
  #                        sp3,
  #                        sp4)
  new_species &lt;- list()
  
  
  manual_traits &lt;- list(
    "dispersal" = c(10, 7.5, 5, 2.5),
    "temp_niche_width" = c(0.5, 1, 2, 4)
  )
  
  for (sp_i in 1:4){
    # create a species empty object
    new_species[[sp_i]] &lt;- create_species(names(pv[pv==sp_i]), config)
    # set manual dispersal and niche width
    new_species[[sp_i]]$traits[ , "dispersal"] &lt;- manual_traits$"dispersal"[sp_i]
    new_species[[sp_i]]$traits[ , "temp_niche_width"] &lt;- manual_traits$"temp_niche_width"[sp_i]
    # set species 1 start to island 1, species 2 to island 2, etc...
    new_species[[sp_i]]$traits[ , "start_island"] &lt;- unique(landscape$environment[pv==sp_i, "patch"]) # this is just a sanity check
    # set species mean temp to the mean temp of the patches
    new_species[[sp_i]]$traits[ , "temp_niche_centre"] &lt;- mean(landscape$environment[pv==sp_i, "mean_temp"])
  }
  
  return(new_species)
}
&lt;environment: 0x00000208771f4170&gt;


$gen3sis$dispersal
$gen3sis$dispersal$max_dispersal
[1] Inf

$gen3sis$dispersal$get_dispersal_values
function(n, species, landscape, config){
  #browser()
  values &lt;- rexp(n, rate = 1/species$traits[,"dispersal"])
  return(values)
}
&lt;environment: 0x00000208771f4170&gt;


$gen3sis$speciation
$gen3sis$speciation$divergence_threshold
[1] 5

$gen3sis$speciation$get_divergence_factor
function(species, cluster_indices, landscape, config) {
  return(1)
}
&lt;environment: 0x00000208771f4170&gt;


$gen3sis$mutation
$gen3sis$mutation$apply_evolution
function(species, cluster_indices, landscape, config) {
  # cell names
  trait_evolutionary_power &lt;-0.05
  traits &lt;- species[["traits"]]
  cells &lt;- rownames(traits)
  #homogenize trait based on abundance
  # Homogenize all traits by weighted abundance, attention, exclude here any trait that should be more neutral
  trn &lt;- config$gen3sis$general$trait_names
  for(cluster_index in unique(cluster_indices)){
    # cluster_index &lt;- 1
    cells_cluster &lt;- cells[which(cluster_indices == cluster_index)]
    # hist(traits[cells_cluster, "temp"], main="before")
    mean_abd &lt;- mean(species$abundance[cells_cluster])
    weight_abd &lt;- species$abundance[cells_cluster]/mean_abd
    for (ti in trn){
      traits[cells_cluster, ti] &lt;- mean(traits[cells_cluster, ti]*weight_abd)
    }
    # hist(traits[cells_cluster, "temp"], main="after")
  }
  
  # mutate mean temperature
  mutation_deltas &lt;-rnorm(length(traits[, ti]), mean=0, sd=trait_evolutionary_power)
  traits[, "temp_niche_centre"] &lt;- traits[, "temp_niche_centre"] + mutation_deltas
  return(traits)
}
&lt;environment: 0x00000208771f4170&gt;


$gen3sis$ecology
$gen3sis$ecology$apply_ecology
function(abundance, traits, landscape, config) {
  # get the difference between species and site mean temp
  diff &lt;- abs(traits[, "temp_niche_centre"]-landscape[,"mean_temp"])
  # set the abundance of species with a difference in mean temp larger than the species temp width to zero and the ones below to one
  abundance[diff&gt;traits[,"temp_niche_width"]] &lt;- 0
  abundance[diff&lt;=traits[,"temp_niche_width"]] &lt;- 1
  return(abundance)
}
&lt;environment: 0x00000208771f4170&gt;



$user
list()

$directories
$directories$input
[1] "data/landscapes/islands"

$directories$output
[1] "output/islands/config_islands_simple_Day1Prac3_M3"

$directories$output_plots
[1] "output/islands/config_islands_simple_Day1Prac3_M3/plots"


attr(,"class")
[1] "gen3sis_config"</code></pre>
</div>
</div>
</section>
<section id="phylogeny-object-phy.nex" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="phylogeny-object-phy.nex">Phylogeny object (phy.nex)</h4>
<p>The phylogeny object is pretty straight forward. It is a nexus file containing the relationships between the species.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># read phy</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>phy <span class="ot">&lt;-</span> <span class="fu">read.nexus</span>(<span class="fu">file.path</span>(output_dir, <span class="st">"config_islands_simple_Day1Prac3_M3/phy.nex"</span>))</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co"># plot phy</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(phy)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Day2_Prac4_outputs_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>From this object we can look at lineages through time plots and estimate trends in diversification. The gamma statistic is one way to detect diversification slowdowns or speedups, with positive values indicating nodes are more closely pushed up towards the tips (speed up) and negative values indicating nodes are closer to the root (slowdown) (<a href="https://royalsocietypublishing.org/doi/10.1098/rspb.2000.1278">Pybus and Harvey 2000</a>). There are lots of other kinds of measures of phylogenetic tree shape, such as metrics of tree imbalance (Colless‚Äôs Index, Beta-Splitting Paramater, etc.)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot an ltt</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>ltt_M1 <span class="ot">&lt;-</span><span class="fu">ltt</span>(phy)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Day2_Prac4_outputs_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># look at the gamma statistic</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">"Gamma = "</span>, <span class="fu">round</span>(ltt_M1<span class="sc">$</span>gamma, <span class="dv">2</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Gamma = -0.69"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># is there a significant deviation from constant rates?</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">"P = "</span>, <span class="fu">round</span>(ltt_M1<span class="sc">$</span>p, <span class="dv">2</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "P = 0.49"</code></pre>
</div>
</div>
</section>
<section id="species-objects-phy.nex" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="species-objects-phy.nex">Species objects (phy.nex)</h4>
<p>Now its time to get into the meat of the gen3sis outputs. Most of the information from the simulation is stored in the species objects. These are .rds files that contain a list which includes information on every species, extinct or extant, that existed during the simulation. These are saved per default at every time step, but can be fine tuned according to your needs. The naming convention is ‚Äúspecies_t_0.rds‚Äù for time step 0 (present-day), and ‚Äúspecies_t_50‚Äù for timestep 50, etc.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load object</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>species_t_0 <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">file.path</span>(output_dir, <span class="st">"config_islands_simple_Day1Prac3_M3"</span>, <span class="st">"species"</span>, <span class="st">"species_t_0.rds"</span>))</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co"># look at object class and length</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(species_t_0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "list"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(species_t_0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 79</code></pre>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># compare to number of tips in the phylogeny</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">Ntip</span>(phy)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 79</code></pre>
</div>
</div>
<p>There are 14 elements in the list, representing our 14 species and this number matches the number of species in our phylogeny. No species went extinct in this particular simulation, but if they did, they would match extinct tips in the phylogeny.</p>
<p>Lets look at a single species</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(species_t_0[[<span class="dv">1</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "id"         "abundance"  "traits"     "divergence"</code></pre>
</div>
</div>
<p>The species has an ID which allows us to match it to the phylogeny.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>species_t_0[[<span class="dv">1</span>]]<span class="sc">$</span>id</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "1"</code></pre>
</div>
</div>
<p>The species‚Äô abundances are also linked to grid cells in the landscape, which can be matched with their corresponding names.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>species_t_0[[<span class="dv">1</span>]]<span class="sc">$</span>abundance</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>249 250 251 252 289 290 291 306 307 313 316 348 349 352 353 354 364 365 366 377 
  1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1 
406 407 408 414 415 423 439 440 465 466 467 476 482 500 525 560 561 584 597 618 
  1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1 
619 620 645 656 657 662 678 679 705 706 716 717 722 723 737 738 766 767 776 783 
  1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1 
784 785 795 796 827 835 836 845 846 847 848 849 853 854 888 889 890 892 893 894 
  1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1 
909 910 951 953 
  1   1   1   1 </code></pre>
</div>
</div>
<p>In this case the species has abundance values of 1 in all populations from the cells that it occupies. This is because we set abundances to be binary: 1=present, 0=absent. We can see the species occupies cells 247, 248, 249, etc.</p>
<p>The species also has values of it‚Äôs traits for each of its populations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(species_t_0[[<span class="dv">1</span>]]<span class="sc">$</span>traits)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    dispersal temp_niche_centre temp_niche_width start_island
249        10          20.77320              0.5            1
250        10          20.78322              0.5            1
251        10          20.84116              0.5            1
252        10          20.76937              0.5            1
289        10          20.77562              0.5            1
290        10          20.85630              0.5            1</code></pre>
</div>
</div>
<p>We can see the population that each row is linked by the rownames. Here you can see 247, 248, 249, etc. Each of these populations have a dispersal trait of 5 (because we didn‚Äôt vary this) slightly different temp_mean traits (because these evolved stochastically under a Brownian motion model) and a temp width of 1 (again, we didn;t vary this in model 1).</p>
<p>So, if we want to map out the distribution of species 1 at timestep 0, we just need to link those cell names (267/268/etc) to the landscape object and make a raster. Why don;t we try and see what islands species 1 is found on.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>))</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="co"># first plot the islands out from the landscape object</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>patch_xyz <span class="ot">&lt;-</span> <span class="fu">rast</span>(lc<span class="sc">$</span>patch[,<span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"0"</span>)], <span class="at">type=</span><span class="st">"xyz"</span>)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(patch_xyz, <span class="at">main=</span><span class="st">"Island Patches"</span>, <span class="at">col=</span><span class="fu">palette</span>()[<span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">6</span>)], <span class="at">colNA=</span><span class="st">"#000033"</span>)</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="co"># pull out values of the landscape where the species is found</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>species1_xyz <span class="ot">&lt;-</span> lc<span class="sc">$</span>patch[<span class="fu">which</span>(<span class="fu">rownames</span>(lc<span class="sc">$</span>patch) <span class="sc">%in%</span> <span class="fu">rownames</span>(species_t_0[[<span class="dv">1</span>]]<span class="sc">$</span>traits)), <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"0"</span>)]</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="co"># turn it into a raster</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>species1_xyz <span class="ot">&lt;-</span> <span class="fu">rast</span>(species1_xyz, <span class="at">type=</span><span class="st">"xyz"</span>)</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>species1_xyz <span class="ot">&lt;-</span> <span class="fu">extend</span>(species1_xyz, patch_xyz)</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(species1_xyz, <span class="at">main=</span> <span class="st">"Species 1 Distribution"</span>, <span class="at">colNA=</span><span class="st">"#000033"</span>)</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a><span class="co"># alternatively we can use the plot_species function on gen3sis..</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a><span class="co"># for that we load the landscape object of the respective time-step</span></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>landscape_t_0 <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">file.path</span>(output_dir, <span class="st">"config_islands_simple_Day1Prac3_M1"</span>, <span class="st">"landscapes"</span>, <span class="st">"landscape_t_0.rds"</span>))</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>gen3sis<span class="sc">::</span><span class="fu">plot_species_presence</span>(species_t_0[[<span class="dv">1</span>]], landscape_t_0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Day2_Prac4_outputs_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="linking-the-species-object-and-phylogeny" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="linking-the-species-object-and-phylogeny">Linking the species object and phylogeny</h4>
<p>Lets try and link the species trait data to the phylogeny to start learning something about what exactly took place during our simulation! Let‚Äôs get the mean trait value of the temperature niche and also the islands that each species belongs too.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># lets create a data frame</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>daf <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="st">"id"</span><span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">"species"</span>,<span class="fu">sapply</span>(species_t_0, <span class="cf">function</span>(x)x<span class="sc">$</span>id)),</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"mean_temp"</span><span class="ot">=</span><span class="cn">NA</span>,</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"island1"</span><span class="ot">=</span><span class="dv">0</span>,</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"island2"</span><span class="ot">=</span><span class="dv">0</span>,</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"island3"</span><span class="ot">=</span><span class="dv">0</span>,</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"island4"</span><span class="ot">=</span><span class="dv">0</span>, </span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"island_start"</span><span class="ot">=</span><span class="cn">NA</span>)</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="co"># take a look</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(daf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        id mean_temp island1 island2 island3 island4 island_start
1 species1        NA       0       0       0       0           NA
2 species2        NA       0       0       0       0           NA
3 species3        NA       0       0       0       0           NA
4 species4        NA       0       0       0       0           NA
5 species5        NA       0       0       0       0           NA
6 species6        NA       0       0       0       0           NA</code></pre>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use sapply on the species object to get their mean trait values</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>daf<span class="sc">$</span>mean_temp <span class="ot">&lt;-</span> <span class="fu">sapply</span>(species_t_0, <span class="cf">function</span>(x){</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># x &lt;- species_t_0[[1]]</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(x<span class="sc">$</span>traits[, <span class="st">"temp_niche_centre"</span>], <span class="at">na.rm=</span>T)</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the island patch id values in a for loop</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(species_t_0)){</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">#I'm here because it is a good idea to test code on a single species before running it on all species</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># i &lt;- 1 </span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># as before we get the lanscape values of each species</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>  speciesi_xyz <span class="ot">&lt;-</span> lc<span class="sc">$</span>patch[<span class="fu">which</span>(<span class="fu">rownames</span>(lc<span class="sc">$</span>patch) <span class="sc">%in%</span> <span class="fu">rownames</span>(species_t_0[[i]]<span class="sc">$</span>traits)), <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"0"</span>)]</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># then pull out the unique values (note that species might occur on more than one island)</span></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>  islands <span class="ot">&lt;-</span> <span class="fu">unique</span>(speciesi_xyz[, <span class="dv">3</span>])</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># then if species are on the island, give that column a value of 1</span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>  daf<span class="sc">$</span>island1[i] <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="dv">1</span> <span class="sc">%in%</span> islands, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>  daf<span class="sc">$</span>island2[i] <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="dv">2</span> <span class="sc">%in%</span> islands, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>  daf<span class="sc">$</span>island3[i] <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="dv">3</span> <span class="sc">%in%</span> islands, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>  daf<span class="sc">$</span>island4[i] <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="dv">4</span> <span class="sc">%in%</span> islands, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a><span class="co"># get the starting island from the traits object since we recorded this in the initialization step</span></span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>daf<span class="sc">$</span>island_start <span class="ot">&lt;-</span> <span class="fu">sapply</span>(species_t_0, <span class="cf">function</span>(xasa) <span class="fu">unique</span>(xasa<span class="sc">$</span>traits[, <span class="st">"start_island"</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now look again at the data frame</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(daf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        id mean_temp island1 island2 island3 island4 island_start
1 species1  20.81620       1       1       0       0            1
2 species2  20.89374       1       1       0       0            2
3 species3  21.13878       0       0       1       0            3
4 species4  21.97150       0       0       0       1            4
5 species5  20.77629       1       1       0       0            1
6 species6  20.79492       1       1       0       0            1</code></pre>
</div>
</div>
<p>Plot out the continuously evolving temperature niche trait</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a named vector for the log of the temperature niche trait</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>temp_niche <span class="ot">&lt;-</span> daf<span class="sc">$</span>mean_temp</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(temp_niche) <span class="ot">&lt;-</span> daf<span class="sc">$</span>id</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="co"># plot it out with dots = trait</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="fu">dotTree</span>(phy,temp_niche,<span class="at">ftype=</span><span class="st">"i"</span>, <span class="at">length=</span><span class="dv">8</span>, <span class="at">fsize=</span><span class="fl">1.2</span>, <span class="at">standardize=</span>T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Day2_Prac4_outputs_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Not much variation in that trait, due to the combined effects of trait homogenization and a low rate of change. Lets plot the tip states of the islands on the phylogeny using the phytools package</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="co"># format each island</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>formatIsland <span class="ot">&lt;-</span> <span class="cf">function</span>(island, <span class="at">phy=</span>phy, <span class="at">daf=</span>daf){</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  islandf <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(daf[, island])</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(islandf) <span class="ot">&lt;-</span> daf<span class="sc">$</span>id</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>  islandmat<span class="ot">&lt;-</span><span class="fu">to.matrix</span>(islandf,<span class="fu">levels</span>(islandf))</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>  islandmat<span class="ot">&lt;-</span>islandmat[phy<span class="sc">$</span>tip.label,]</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(islandf, islandmat))</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a><span class="fu">plotTree</span>(phy,<span class="at">ftype=</span><span class="st">"i"</span>,<span class="at">offset=</span><span class="dv">1</span>,<span class="at">fsize=</span><span class="fl">0.9</span>, <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">75</span>))</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a><span class="fu">tiplabels</span>(<span class="at">pie=</span><span class="fu">formatIsland</span>(<span class="at">island=</span><span class="st">"island1"</span>, <span class="at">phy=</span>phy, <span class="at">daf=</span>daf)[[<span class="dv">2</span>]],<span class="at">piecol=</span><span class="fu">palette</span>()[<span class="fu">c</span>(<span class="dv">8</span>,<span class="dv">2</span>)],<span class="at">cex=</span><span class="fl">0.6</span>, <span class="at">adj=</span><span class="dv">12</span><span class="sc">+</span><span class="dv">1</span>)</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a><span class="fu">tiplabels</span>(<span class="at">pie=</span><span class="fu">formatIsland</span>(<span class="at">island=</span><span class="st">"island2"</span>, <span class="at">phy=</span>phy, <span class="at">daf=</span>daf)[[<span class="dv">2</span>]],<span class="at">piecol=</span><span class="fu">palette</span>()[<span class="fu">c</span>(<span class="dv">8</span>,<span class="dv">3</span>)],<span class="at">cex=</span><span class="fl">0.6</span>, <span class="at">adj=</span><span class="dv">12</span><span class="sc">+</span><span class="dv">3</span>)</span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a><span class="fu">tiplabels</span>(<span class="at">pie=</span><span class="fu">formatIsland</span>(<span class="at">island=</span><span class="st">"island3"</span>, <span class="at">phy=</span>phy, <span class="at">daf=</span>daf)[[<span class="dv">2</span>]],<span class="at">piecol=</span><span class="fu">palette</span>()[<span class="fu">c</span>(<span class="dv">8</span>,<span class="dv">4</span>)],<span class="at">cex=</span><span class="fl">0.6</span>, <span class="at">adj=</span><span class="dv">12</span><span class="sc">+</span><span class="dv">5</span>)</span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a><span class="fu">tiplabels</span>(<span class="at">pie=</span><span class="fu">formatIsland</span>(<span class="at">island=</span><span class="st">"island4"</span>, <span class="at">phy=</span>phy, <span class="at">daf=</span>daf)[[<span class="dv">2</span>]],<span class="at">piecol=</span><span class="fu">palette</span>()[<span class="fu">c</span>(<span class="dv">8</span>,<span class="dv">6</span>)],<span class="at">cex=</span><span class="fl">0.6</span>, <span class="at">adj=</span><span class="dv">12</span><span class="sc">+</span><span class="dv">7</span>)</span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(patch_xyz, <span class="at">main=</span><span class="st">"Island Patches"</span>, <span class="at">col=</span><span class="fu">palette</span>()[<span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">6</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Day2_Prac4_outputs_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Interesting. What do you notice about the distribution of species on islands? Could you predict which island each lineage began on?</p>
<p>We actually know which islands each lineage started on because we recorded this as a trait (we could also look at the past species objects to figure this out but we have used a shortcut though the traits).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plotTree</span>(phy,<span class="at">ftype=</span><span class="st">"i"</span>,<span class="at">offset=</span><span class="dv">1</span>,<span class="at">fsize=</span><span class="fl">0.4</span>, <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">75</span>))</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>my_cex<span class="ot">=</span><span class="fl">1.2</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="fu">tiplabels</span>(<span class="at">pie=</span><span class="fu">formatIsland</span>(<span class="at">island=</span><span class="st">"island1"</span>, <span class="at">phy=</span>phy, <span class="at">daf=</span>daf)[[<span class="dv">2</span>]],<span class="at">piecol=</span><span class="fu">palette</span>()[<span class="fu">c</span>(<span class="dv">8</span>,<span class="dv">2</span>)],<span class="at">cex=</span>my_cex, <span class="at">adj=</span><span class="dv">12</span><span class="sc">+</span><span class="dv">1</span>)</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="fu">tiplabels</span>(<span class="at">pie=</span><span class="fu">formatIsland</span>(<span class="at">island=</span><span class="st">"island2"</span>, <span class="at">phy=</span>phy, <span class="at">daf=</span>daf)[[<span class="dv">2</span>]],<span class="at">piecol=</span><span class="fu">palette</span>()[<span class="fu">c</span>(<span class="dv">8</span>,<span class="dv">3</span>)],<span class="at">cex=</span>my_cex, <span class="at">adj=</span><span class="dv">12</span><span class="sc">+</span><span class="dv">3</span>)</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="fu">tiplabels</span>(<span class="at">pie=</span><span class="fu">formatIsland</span>(<span class="at">island=</span><span class="st">"island3"</span>, <span class="at">phy=</span>phy, <span class="at">daf=</span>daf)[[<span class="dv">2</span>]],<span class="at">piecol=</span><span class="fu">palette</span>()[<span class="fu">c</span>(<span class="dv">8</span>,<span class="dv">4</span>)],<span class="at">cex=</span>my_cex, <span class="at">adj=</span><span class="dv">12</span><span class="sc">+</span><span class="dv">5</span>)</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="fu">tiplabels</span>(<span class="at">pie=</span><span class="fu">formatIsland</span>(<span class="at">island=</span><span class="st">"island4"</span>, <span class="at">phy=</span>phy, <span class="at">daf=</span>daf)[[<span class="dv">2</span>]],<span class="at">piecol=</span><span class="fu">palette</span>()[<span class="fu">c</span>(<span class="dv">8</span>,<span class="dv">6</span>)],<span class="at">cex=</span>my_cex, <span class="at">adj=</span><span class="dv">12</span><span class="sc">+</span><span class="dv">7</span>)</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="co"># add the starting island as a fifth colum</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="fu">tiplabels</span>(<span class="at">pie=</span><span class="fu">formatIsland</span>(<span class="at">island=</span><span class="st">"island_start"</span>, <span class="at">phy=</span>phy, <span class="at">daf=</span>daf)[[<span class="dv">2</span>]],<span class="at">piecol=</span><span class="fu">palette</span>()[<span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">6</span>)],<span class="at">cex=</span><span class="fl">1.6</span>, <span class="at">adj=</span><span class="dv">12</span><span class="sc">+</span><span class="dv">9</span>, <span class="at">pch=</span><span class="dv">7</span>)</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a><span class="co"># add island plot</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(patch_xyz, <span class="at">main=</span><span class="st">"Island Patches"</span>, <span class="at">col=</span><span class="fu">palette</span>()[<span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">6</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Day2_Prac4_outputs_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>So whats really apparent here is that the clade that originated on the green island has speciated allopatrically into the red island multiple times in the recent past. The same is true for the red clade, however the deeper divergence between species9 and species3 have had enough time to recolonize both islands.</p>
</section>
<section id="linking-the-species-object-landscape-and-phylogeny" class="level4" data-number="4.0.0.1">
<h4 data-number="4.0.0.1" class="anchored" data-anchor-id="linking-the-species-object-landscape-and-phylogeny"><span class="header-section-number">4.0.0.1</span> Linking the species object, landscape, and phylogeny</h4>
<p>Common spatial biodiversity analyses link information measured at the species level to maps of their distribution in space using presence-absence matrices or PAMs. PAMs typically are data frame with each row representing a site, could be an island or could be a grid cell, and each column representing a species. Values of 1 are given if the species is present in the site, if not a value of 0 is given.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># grid cell level PAM</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="co"># create an empty data frame with the dimensions of species x sites</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>PAM <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow=</span><span class="fu">nrow</span>(lc<span class="sc">$</span>elevation), <span class="at">ncol=</span><span class="fu">length</span>(species_t_0)))</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="co"># given names to rows and columns</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(PAM) <span class="ot">&lt;-</span> <span class="fu">rownames</span>(lc<span class="sc">$</span>elevation)</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(PAM) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"species"</span>, <span class="fu">sapply</span>(species_t_0, <span class="cf">function</span>(x)x<span class="sc">$</span>id))</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a><span class="co"># loop over species and add value of 1 to all sites the species is present</span></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(species_t_0)){</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>  PAM[<span class="fu">which</span>(<span class="fu">rownames</span>(PAM) <span class="sc">%in%</span> <span class="fu">names</span>(species_t_0[[i]]<span class="sc">$</span>abundance)), i] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a><span class="co"># how does it look?</span></span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(PAM[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   species1 species2 species3 species4 species5 species6 species7 species8
1         0        0        0        0        0        0        0        0
2         0        0        0        0        0        0        0        0
3         0        0        0        0        0        0        0        0
4         0        0        0        0        0        0        0        0
5         0        0        0        0        0        0        0        0
6         0        0        0        0        0        0        0        0
7         0        0        0        0        0        0        0        0
8         0        0        0        0        0        0        0        0
9         0        0        0        0        0        0        0        0
10        0        0        0        0        0        0        0        0
   species9 species10
1         0         0
2         0         0
3         0         0
4         0         0
5         0         0
6         0         0
7         0         0
8         0         0
9         0         0
10        0         0</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we can estimate Phylogenetic diversity</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>pd_islands <span class="ot">&lt;-</span> <span class="fu">pd</span>(PAM, phy)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="co"># we can also measure mean phylogenetic distance and mean nearest neighbour distance</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>mpd_islands <span class="ot">&lt;-</span> <span class="fu">mpd</span>(PAM, <span class="fu">cophenetic</span>(phy))</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>mntd_islands <span class="ot">&lt;-</span> <span class="fu">mntd</span>(PAM,<span class="fu">cophenetic</span>(phy))</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a><span class="co"># link these back with the landscape by joining to the landscape lat/long</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>community_phylo <span class="ot">&lt;-</span> <span class="fu">cbind</span>(lc<span class="sc">$</span>elevation[, <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>)], pd_islands, mpd_islands, mntd_islands)</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>sr_ras <span class="ot">&lt;-</span> <span class="fu">rast</span>(community_phylo[, <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"SR"</span>)], <span class="at">type=</span><span class="st">"xyz"</span>)</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>pd_ras <span class="ot">&lt;-</span> <span class="fu">rast</span>(community_phylo[, <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"PD"</span>)], <span class="at">type=</span><span class="st">"xyz"</span>)</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>mpd_ras <span class="ot">&lt;-</span> <span class="fu">rast</span>(community_phylo[, <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"mpd_islands"</span>)], <span class="at">type=</span><span class="st">"xyz"</span>)</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>mntd_ras <span class="ot">&lt;-</span> <span class="fu">rast</span>(community_phylo[, <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"mntd_islands"</span>)], <span class="at">type=</span><span class="st">"xyz"</span>)</span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(sr_ras, <span class="at">main=</span><span class="st">"Species Richness"</span>, <span class="at">na.color =</span><span class="st">"red"</span>)</span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pd_ras, <span class="at">main=</span><span class="st">"Phylogenetic Diversity"</span>)</span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mpd_ras, <span class="at">main=</span><span class="st">"Mean Phylogenetic Pairwise Distance"</span>)</span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mntd_ras, <span class="at">main=</span> <span class="st">"Mean Nearest Neighbour Phylogenetic Distance"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Day2_Prac4_outputs_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="sensitivity-analysis" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="sensitivity-analysis">Sensitivity analysis</h2>
<p>In this part we are going to load in a data set from Skeels et al.&nbsp;(2022) <em>SystBiol</em> in which we simulated data with Gen3sis under four alternative models to test the evolutionary speed hypothesis (ESH). The ESH hypothesizes that faster rates of evolution occurs in lineages from warm regions like the tropics because they are have higher mutagenesis from faster life histories associated with warm temperatures and smaller body sizes. The four models used there were</p>
<ul>
<li><p>M0 - the null. population divergence is independent of temperature and body size</p></li>
<li><p>M1 - Temperature Trailblazer. environmental temperature drives rate of population divergence</p></li>
<li><p>M2 - Size Shaper. body size drives the rate of population divergence</p></li>
<li><p>M3 - Synergistic Drivers. environmental temperature and body size drives the rate of population divergence</p></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figures/systbiol_fig1.jpeg" class="img-fluid figure-img"></p>
<figcaption>Skeels et al.&nbsp;2022 Syst. Biol. Figure 1</figcaption>
</figure>
</div>
<p>Not only did we change the overall model of evolution, we also varied key parameters for rates of niche evolution (simga_squared_t), rates of body size evolution (sigma_squared_bs), dispersal, and the temperature niche breadth (omega), the exponent of the divergence factor with temp/body size (lambda), and the divergence threshold. Load in the data and take a look, the first 6 columns are the model parameters we varied.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>sim_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/simulated_summary_statistics.csv"</span>)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="co"># look at the first few columns</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(sim_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  divergence_threshold lambda omega sigma_squared_bs sigma_squared_t dispersal
1                    6  3.497 0.022            0.010           0.008     2.748
2                    8  2.743 0.029            0.006           0.012     2.119
3                    4  4.251 0.016            0.015           0.004     3.376
4                    5  3.120 0.026            0.003           0.013     3.691
5                    9  4.629 0.013            0.013           0.006     2.433
6                    7  2.365 0.019            0.008           0.003     3.062
   m n_extant_diversity richness_lat_cor richness_temp0mya_cor temp_skewness
1 m0               3763       -0.5123028             0.4603989    -0.3377488
2 m0               2514       -0.4425833             0.3879755    -0.4301348
3 m0               2881       -0.6090030             0.5980889    -0.5485366
4 m0               3259       -0.2692291             0.2709599    -0.4056149
5 m0               1720       -0.6320276             0.5569583    -0.2034315
6 m0               2040       -0.6901237             0.7143851    -0.5818263
  temp_kurtosis rs_skewness rs_kurtosis bodysize_temp_cor
1      2.404199    7.054563    70.57922      0.0001267958
2      2.781235    7.065556    73.60686     -0.0573601538
3      2.686734    6.568041    66.80411      0.0627634742
4      2.578726    6.372164    56.40946     -0.0099951252
5      2.039092    5.943670    62.21730     -0.0491801922
6      2.692505    5.557220    43.19415     -0.1425113733
  bodysize_rangesize_cor rangesize_temp_cor bodysize_MRDa_cor bodysize_MRDn_cor
1           -0.021888162          0.3166909       -0.22987475       -0.22987475
2           -0.004099039          0.3750050        0.11431674        0.11431674
3           -0.007583409          0.1745926       -0.17385167       -0.17385167
4            0.019477523          0.3315223        0.15882106        0.15882106
5           -0.020735305          0.3106268       -0.01367189       -0.01367189
6           -0.068035906          0.2386339       -0.25345879       -0.25345879
  bodysize_MRDs_cor bodysize_ED_cor bodysize_ES_cor bodysize_DR_cor
1       -0.22987475    -0.004220075    -0.001379360     0.004220206
2        0.11431674    -0.048918445    -0.047336234     0.048918445
3       -0.17385167     0.156214848     0.124189954    -0.156214848
4        0.15882106     0.025569939     0.020867045    -0.025569939
5       -0.01367189    -0.091018579    -0.071841554     0.091018579
6       -0.25345879    -0.011839185    -0.009998883     0.011839185
  temp_MRDa_cor temp_MRDn_cor temp_MRDs_cor temp_ED_cor temp_ES_cor temp_DR_cor
1   -0.26576712   -0.26576712   -0.26576712  0.26183743   0.2202009 -0.26183732
2   -0.17175772   -0.17175772   -0.17175772  0.24312164   0.2193826 -0.24312164
3   -0.26126033   -0.26126033   -0.26126033  0.20306519   0.2015201 -0.20306519
4   -0.18047283   -0.18047283   -0.18047283  0.09627562   0.0921575 -0.09627562
5   -0.29855804   -0.29855804   -0.29855804  0.51772365   0.4230468 -0.51772365
6    0.05847105    0.05847105    0.05847105  0.11024859   0.1080941 -0.11024859
  rangesize_MRDa_cor rangesize_MRDn_cor rangesize_MRDs_cor rangesize_ED_cor
1        -0.06934918        -0.06934918        -0.06934918       0.08511133
2        -0.10091990        -0.10091990        -0.10091990       0.12507118
3         0.04022504         0.04022504         0.04022504      -0.09452590
4        -0.04660310        -0.04660310        -0.04660310       0.07933631
5        -0.13259037        -0.13259037        -0.13259037       0.18191779
6         0.06267093         0.06267093         0.06267093      -0.01025940
  rangesize_ES_cor rangesize_DR_cor  collessI    sackinI     gamma  lat_pd_cor
1      0.077434173      -0.08511127 1.2941150  1.2446979 -2.842964  0.31465895
2      0.122658910      -0.12507118 0.2469526  0.3055442 -3.432895  0.25315279
3     -0.069705157       0.09452590 1.7248814  1.6445494  3.552396  0.18284230
4      0.087443271      -0.07933631 0.1092457 -0.1254847 -2.856134  0.11539323
5      0.147346956      -0.18191779 1.9250034  1.8373325  1.221135 -0.06489522
6      0.006120436       0.01025940 1.4952264  1.3605311 -5.120426  0.53662583
  lat_mpd_cor lat_mntd_cor temp_pd_cor temp_mpd_cor temp_mntd_cor
1  0.03036122   0.33145967 -0.24781657   0.01816540  -0.268472337
2  0.10829373   0.24772423 -0.19630776  -0.09235074  -0.184665665
3  0.18551711   0.24143456 -0.18427695  -0.19302604  -0.243213118
4 -0.03477720   0.15145822 -0.09837927   0.03810852  -0.129764794
5 -0.20454388   0.09798374  0.14050779   0.24629073  -0.006957113
6  0.46224942   0.53924111 -0.54984407  -0.47923803  -0.551691573
  richness_pd_cor richness_mpd_cor richness_mntd_cor temp_bsm_cor temp_bssd_cor
1      -0.7653721      -0.41190740        -0.7499123   0.13029352    0.10296607
2      -0.5019377      -0.13404370        -0.4901978   0.02405246    0.32276835
3      -0.4206957      -0.37006059        -0.5361401   0.29116267    0.28959998
4      -0.6620540      -0.41176821        -0.6769946  -0.05320780    0.04856645
5      -0.1328847       0.06086838        -0.2905060  -0.08286640    0.08193951
6      -0.8328187      -0.71895993        -0.8346579   0.31747185    0.34586235
  richness_bsm_cor richness_bssd_cor   pd_bsm_cor mpd_bsm_cor mntd_bsm_cor
1       0.11558582         0.2699839  0.003325102   0.2260060  -0.05039301
2      -0.04537885         0.3499518 -0.263036186  -0.2484294  -0.25064129
3       0.23668036         0.3628398  0.515713659   0.4795434   0.49672112
4       0.04042515         0.1778522 -0.052266148  -0.1187109  -0.03605613
5       0.31046985         0.3722813  0.061612978   0.1029425   0.06221910
6       0.45747017         0.3837205 -0.038428520   0.3474728  -0.12562991</code></pre>
</div>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># look at the models</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(sim_data<span class="sc">$</span>m)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "m0" "m1" "m2" "m3"</code></pre>
</div>
</div>
<p>This data set has 27 metrics used in our paper to measure patterns in the distribution of species, such as range size metrics, or correlations between temperature and diversity, as well as phylogenetic tree shape metrics, such as gamma, and measures of functional diversity, like body size variance. We predicted that these different models of evolution (M0-M4) should leave discernible signatures in these metrics. We can plot a few associations between biodiversity metrics and these model parameters to test this hypothesis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(ggplot2)</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="co"># how is diversity related to the dispersal ability of a clade?</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sim_data, <span class="fu">aes</span>(<span class="at">x=</span>m, <span class="at">y=</span><span class="fu">log</span>(n_extant_diversity), <span class="at">fill=</span>m))<span class="sc">+</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha=</span><span class="fl">0.7</span>, <span class="at">position =</span> <span class="st">"jitter"</span>)<span class="sc">+</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">alpha=</span><span class="fl">0.7</span>)<span class="sc">+</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_smooth</span>()<span class="sc">+</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Day2_Prac4_outputs_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># how about the temperature~diversity gradient?</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sim_data, <span class="fu">aes</span>(<span class="at">x=</span>m, <span class="at">y=</span>richness_temp0mya_cor, <span class="at">fill=</span>m))<span class="sc">+</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha=</span><span class="fl">0.7</span>, <span class="at">position =</span> <span class="st">"jitter"</span>)<span class="sc">+</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">alpha=</span><span class="fl">0.7</span>)<span class="sc">+</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_smooth</span>()<span class="sc">+</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Day2_Prac4_outputs_files/figure-html/unnamed-chunk-25-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># how about the relationship between  body size and diversification rate?</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sim_data, <span class="fu">aes</span>(<span class="at">x=</span>m, <span class="at">y=</span>bodysize_DR_cor, <span class="at">fill=</span>m))<span class="sc">+</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha=</span><span class="fl">0.7</span>, <span class="at">position =</span> <span class="st">"jitter"</span>)<span class="sc">+</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">alpha=</span><span class="fl">0.7</span>)<span class="sc">+</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_smooth</span>()<span class="sc">+</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Day2_Prac4_outputs_files/figure-html/unnamed-chunk-25-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># how about the relationship between temperature and diversification rate?</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sim_data, <span class="fu">aes</span>(<span class="at">x=</span>m, <span class="at">y=</span>temp_DR_cor, <span class="at">fill=</span>m))<span class="sc">+</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha=</span><span class="fl">0.7</span>, <span class="at">position =</span> <span class="st">"jitter"</span>)<span class="sc">+</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">alpha=</span><span class="fl">0.7</span>)<span class="sc">+</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_smooth</span>()<span class="sc">+</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Day2_Prac4_outputs_files/figure-html/unnamed-chunk-25-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Do these patterns fit our predictions? We can also look at how some of these metrics varied with the continuous model parameters such as dispersal ability.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># how is diversity related to the dispersal ability of a clade?</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sim_data, <span class="fu">aes</span>(<span class="at">x=</span>dispersal, <span class="at">y=</span><span class="fu">log</span>(n_extant_diversity)))<span class="sc">+</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha=</span><span class="fl">0.7</span>)<span class="sc">+</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_smooth</span>()<span class="sc">+</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Day2_Prac4_outputs_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># how about the latitude diversity gradient?</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sim_data, <span class="fu">aes</span>(<span class="at">x=</span>dispersal, <span class="at">y=</span>temp_DR_cor))<span class="sc">+</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha=</span><span class="fl">0.7</span>)<span class="sc">+</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_smooth</span>()<span class="sc">+</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Day2_Prac4_outputs_files/figure-html/unnamed-chunk-26-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>To perform a simple kind of sensitivity test we might ask how each of the model parameters predicts linear changes in the distribution of a biodiversity patterns using a multiple regression model. One example where we have a good idea of what the relationship should be is the how variance in the distribution of temperature niches across species (e.g., skewness of the distribution) relates to model paramaters. We expect that this should scale with the rate of rate of temperature niche evolution - faster rates of change = more variation in the trait = more kutosis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># first scale parameters to be in the same units</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>sim_data_scaled <span class="ot">&lt;-</span> sim_data</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>sim_data_scaled[,<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>] <span class="ot">&lt;-</span> <span class="fu">scale</span>(sim_data_scaled[,<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>] )</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a><span class="co"># fit the multiple regression</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>lm1  <span class="ot">&lt;-</span> <span class="fu">lm</span>(temp_kurtosis <span class="sc">~</span> divergence_threshold<span class="sc">+</span>lambda<span class="sc">+</span>omega<span class="sc">+</span>sigma_squared_bs<span class="sc">+</span>sigma_squared_t<span class="sc">+</span>dispersal, <span class="at">data=</span>sim_data_scaled)</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a><span class="co"># look at model coefficients</span></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = temp_kurtosis ~ divergence_threshold + lambda + 
    omega + sigma_squared_bs + sigma_squared_t + dispersal, data = sim_data_scaled)

Residuals:
    Min      1Q  Median      3Q     Max 
-2.7214 -0.7281 -0.3103  0.2481 22.9740 

Coefficients:
                     Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)           3.26301    0.04670  69.872  &lt; 2e-16 ***
divergence_threshold  0.48515    0.04978   9.745  &lt; 2e-16 ***
lambda                0.22304    0.04717   4.729 2.49e-06 ***
omega                 0.07447    0.04769   1.562    0.119    
sigma_squared_bs      0.02415    0.04677   0.516    0.606    
sigma_squared_t       0.29197    0.04690   6.225 6.37e-10 ***
dispersal             0.26180    0.04915   5.326 1.17e-07 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 1.737 on 1377 degrees of freedom
Multiple R-squared:  0.1076,    Adjusted R-squared:  0.1037 
F-statistic: 27.68 on 6 and 1377 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>What do you see? Are our expectations met? Any surprises? Let‚Äôs try a few other biodiversity patterns where the predictions are less clear.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fit the multiple regressions</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Gamma statsitic for phylogenetic tree shape</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>lm2  <span class="ot">&lt;-</span> <span class="fu">lm</span>(gamma <span class="sc">~</span> divergence_threshold<span class="sc">+</span>lambda<span class="sc">+</span>omega<span class="sc">+</span>sigma_squared_bs<span class="sc">+</span>sigma_squared_t<span class="sc">+</span>dispersal, <span class="at">data=</span>sim_data_scaled)</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a><span class="co"># skewness of the range size distribution of species</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>lm3  <span class="ot">&lt;-</span> <span class="fu">lm</span>(rs_skewness <span class="sc">~</span> divergence_threshold<span class="sc">+</span>lambda<span class="sc">+</span>omega<span class="sc">+</span>sigma_squared_bs<span class="sc">+</span>sigma_squared_t<span class="sc">+</span>dispersal, <span class="at">data=</span>sim_data_scaled)</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a><span class="co"># correlation between species range sizes and temperature</span></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>lm4  <span class="ot">&lt;-</span> <span class="fu">lm</span>(rangesize_temp_cor <span class="sc">~</span> divergence_threshold<span class="sc">+</span>lambda<span class="sc">+</span>omega<span class="sc">+</span>sigma_squared_bs<span class="sc">+</span>sigma_squared_t<span class="sc">+</span>dispersal, <span class="at">data=</span>sim_data_scaled)</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a><span class="co"># look at model coefficients</span></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = gamma ~ divergence_threshold + lambda + omega + 
    sigma_squared_bs + sigma_squared_t + dispersal, data = sim_data_scaled)

Residuals:
     Min       1Q   Median       3Q      Max 
-14.6901  -3.3262  -0.3125   3.0625  19.1039 

Coefficients:
                     Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)           1.58975    0.13209  12.035  &lt; 2e-16 ***
divergence_threshold -1.67245    0.14081 -11.877  &lt; 2e-16 ***
lambda               -0.36850    0.13341  -2.762  0.00582 ** 
omega                 1.13745    0.13489   8.432  &lt; 2e-16 ***
sigma_squared_bs      0.04682    0.13230   0.354  0.72347    
sigma_squared_t      -0.17454    0.13266  -1.316  0.18848    
dispersal             0.99940    0.13903   7.188 1.07e-12 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 4.914 on 1377 degrees of freedom
Multiple R-squared:  0.2175,    Adjusted R-squared:  0.2141 
F-statistic: 63.78 on 6 and 1377 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = rs_skewness ~ divergence_threshold + lambda + omega + 
    sigma_squared_bs + sigma_squared_t + dispersal, data = sim_data_scaled)

Residuals:
    Min      1Q  Median      3Q     Max 
-5.5219 -1.7186 -0.2771  1.3923 21.2181 

Coefficients:
                     Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)           6.14631    0.06701  91.717  &lt; 2e-16 ***
divergence_threshold -2.11448    0.07144 -29.598  &lt; 2e-16 ***
lambda               -0.60219    0.06768  -8.897  &lt; 2e-16 ***
omega                -0.31157    0.06844  -4.553 5.76e-06 ***
sigma_squared_bs      0.22387    0.06712   3.335 0.000875 ***
sigma_squared_t      -0.57043    0.06730  -8.476  &lt; 2e-16 ***
dispersal            -1.33498    0.07053 -18.927  &lt; 2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 2.493 on 1377 degrees of freedom
Multiple R-squared:  0.4552,    Adjusted R-squared:  0.4528 
F-statistic: 191.8 on 6 and 1377 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = rangesize_temp_cor ~ divergence_threshold + lambda + 
    omega + sigma_squared_bs + sigma_squared_t + dispersal, data = sim_data_scaled)

Residuals:
     Min       1Q   Median       3Q      Max 
-0.72559 -0.08895  0.01488  0.09329  0.68488 

Coefficients:
                      Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)           0.197748   0.004238  46.658  &lt; 2e-16 ***
divergence_threshold -0.029361   0.004518  -6.498 1.13e-10 ***
lambda               -0.022882   0.004281  -5.345 1.05e-07 ***
omega                -0.042760   0.004328  -9.879  &lt; 2e-16 ***
sigma_squared_bs     -0.001199   0.004245  -0.283    0.778    
sigma_squared_t       0.041124   0.004256   9.662  &lt; 2e-16 ***
dispersal            -0.019362   0.004461  -4.340 1.53e-05 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.1577 on 1377 degrees of freedom
Multiple R-squared:  0.1388,    Adjusted R-squared:  0.135 
F-statistic: 36.99 on 6 and 1377 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>In all these cases there are interesting associations between model parameters and the biodiversity metrics. However, look at the R-squared values and what do you find? They are highly variable and in some cases quite low. This means that lots of variance in these biodiversity metrics are not explained by a linear combination of our model parameters. This is important when interpreting the effect. There are other ways of inferring more complex relationships between model parameters and biodiversity metrics, such as by including quadratic effects, exploring interaction terms, fitting non-linear models such as generalised additive models (GAMs), or even using machine learning methods such as neural networks which allow for highly-dimension non-linear effects. We won‚Äôt cover these today but they are all useful options to explore during sensitivity analysis.</p>
<section id="model-selection" class="level3" data-number="4.0.1">
<h3 data-number="4.0.1" class="anchored" data-anchor-id="model-selection"><span class="header-section-number">4.0.1</span> Model Selection</h3>
<p>Once we have established that some biodiversity metrics showed predictable relationships with model parameters or the generative model (e.g., M0-M4) we can use these metrics to perform model selection on empirical data. Here we are using the match between observed biodiversity patterns and simulated biodiversity patterns, to ask which model might be most likely to have generated the real patterns.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figures/systbiol_fig2.jpeg" class="img-fluid figure-img"></p>
<figcaption>Skeels et al.&nbsp;2022 Syst. Biol. Figure 2</figcaption>
</figure>
</div>
<p>To do this we are going to perform a linear discriminant analysis which is a classification tool that can fit fit fairly quickly compared to some of the other models. We want to validate how well the model performs so we will perform a 10-fold cross validation repeated 10 times. Here we train the model on a subset of the data, repeating the process and optimising the predictive capacity. Then we predict how good a job our classifier is on a witheld portion of the data (test data). If the model performs well we should be able to accurately predict what models generated what biodiversity metrics.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(caret)</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="co"># get just the biodiversity metrics</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>sim_data_ms <span class="ot">&lt;-</span> sim_data[,<span class="dv">7</span><span class="sc">:</span><span class="fu">ncol</span>(sim_data)]</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a><span class="co"># remove MRDs variables from sim data</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>sim_data_ms <span class="ot">&lt;-</span> sim_data_ms[, <span class="sc">-</span><span class="fu">which</span>(<span class="fu">grepl</span>(<span class="st">"MRDs"</span>,<span class="fu">colnames</span>(sim_data_ms)))]</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a><span class="co"># partition into a training and testing dataset for cross validation</span></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>train_index <span class="ot">&lt;-</span> <span class="fu">createDataPartition</span>(sim_data_ms<span class="sc">$</span>m, <span class="at">p =</span> .<span class="dv">66</span>, <span class="at">list =</span> <span class="cn">FALSE</span>,  <span class="at">times =</span> <span class="dv">1</span>)</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>train_data <span class="ot">&lt;-</span> sim_data_ms[ train_index ,]</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>test_data  <span class="ot">&lt;-</span> sim_data_ms[<span class="sc">-</span>train_index ,]</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a><span class="co"># preprocess values - we will scale and center values</span></span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>preprocessed_values <span class="ot">&lt;-</span> <span class="fu">preProcess</span>(train_data, <span class="at">method =</span> <span class="fu">c</span>(<span class="st">"center"</span>, <span class="st">"scale"</span>))</span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>train_transformed   <span class="ot">&lt;-</span> <span class="fu">predict</span>(preprocessed_values, train_data)</span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a>test_transformed    <span class="ot">&lt;-</span> <span class="fu">predict</span>(preprocessed_values, test_data )</span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a><span class="co"># configure the cross-validation paramaters</span></span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a>train_control <span class="ot">&lt;-</span> <span class="fu">trainControl</span>( <span class="at">method =</span> <span class="st">"repeatedcv"</span>, <span class="at">number =</span> <span class="dv">10</span>, <span class="at">repeats =</span> <span class="dv">10</span>, <span class="at">classProbs =</span> <span class="cn">TRUE</span>, <span class="at">savePredictions =</span> <span class="cn">TRUE</span>)</span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a><span class="co"># FIT MODELS</span></span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a>f1 <span class="ot">&lt;-</span> <span class="fu">formula</span>(<span class="fu">paste</span>(<span class="st">"m ~ "</span>, <span class="fu">paste</span>(<span class="fu">names</span>(sim_data_ms)[<span class="dv">2</span><span class="sc">:</span><span class="fu">c</span>(<span class="fu">length</span>(<span class="fu">names</span>(sim_data_ms)))], <span class="at">collapse=</span><span class="st">" + "</span>)))</span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a><span class="do">## LINEAR DISCRIMINANT ANALYSIS</span></span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true" tabindex="-1"></a><span class="co"># note we'll run an LDA because they're quick - many other kinds of models to choose from </span></span>
<span id="cb70-26"><a href="#cb70-26" aria-hidden="true" tabindex="-1"></a>lda_train        <span class="ot">&lt;-</span> <span class="fu">train</span>(f1, <span class="at">data=</span>train_transformed, <span class="at">method =</span> <span class="st">"lda"</span>, <span class="at">trControl =</span> train_control, <span class="at">verbose =</span> T)</span>
<span id="cb70-27"><a href="#cb70-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-28"><a href="#cb70-28" aria-hidden="true" tabindex="-1"></a><span class="co">#predict on test data</span></span>
<span id="cb70-29"><a href="#cb70-29" aria-hidden="true" tabindex="-1"></a>lda_test        <span class="ot">&lt;-</span> <span class="fu">predict</span>(lda_train, test_transformed)</span>
<span id="cb70-30"><a href="#cb70-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-31"><a href="#cb70-31" aria-hidden="true" tabindex="-1"></a><span class="co"># classification accuracy</span></span>
<span id="cb70-32"><a href="#cb70-32" aria-hidden="true" tabindex="-1"></a>lda_cm        <span class="ot">&lt;-</span> <span class="fu">confusionMatrix</span>(<span class="at">data =</span> lda_test, <span class="at">reference =</span> <span class="fu">as.factor</span>(test_transformed<span class="sc">$</span>m), <span class="at">mode =</span> <span class="st">"prec_recall"</span>)</span>
<span id="cb70-33"><a href="#cb70-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-34"><a href="#cb70-34" aria-hidden="true" tabindex="-1"></a><span class="co"># how well did the model perform</span></span>
<span id="cb70-35"><a href="#cb70-35" aria-hidden="true" tabindex="-1"></a>lda_cm </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix and Statistics

          Reference
Prediction m0 m1 m2 m3
        m0 97 23  2 10
        m1 15 84  0  6
        m2  1  3 81 24
        m3  4  6 34 77

Overall Statistics
                                         
               Accuracy : 0.7259         
                 95% CI : (0.683, 0.7659)
    No Information Rate : 0.2505         
    P-Value [Acc &gt; NIR] : &lt;2e-16         
                                         
                  Kappa : 0.6345         
                                         
 Mcnemar's Test P-Value : 0.1567         

Statistics by Class:

                     Class: m0 Class: m1 Class: m2 Class: m3
Precision               0.7348    0.8000    0.7431    0.6364
Recall                  0.8291    0.7241    0.6923    0.6581
F1                      0.7791    0.7602    0.7168    0.6471
Prevalence              0.2505    0.2484    0.2505    0.2505
Detection Rate          0.2077    0.1799    0.1734    0.1649
Detection Prevalence    0.2827    0.2248    0.2334    0.2591
Balanced Accuracy       0.8645    0.8322    0.8062    0.7662</code></pre>
</div>
</div>
<p>Whats the overall accuracy? Are some models predicted better than others?</p>
<p>Now we‚Äôll use this model to predict the possible model of diversification in orders of terrestrial vertebrates.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># first subset and clean the colnames of the empirical data</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>empirical_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/order_empirical_summary_statistics.csv"</span>)</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="co"># just want to look at diverse clades</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>empirical_data <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(empirical_data[<span class="fu">which</span>(empirical_data<span class="sc">$</span>n_species <span class="sc">&gt;=</span> <span class="dv">20</span>),])</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a><span class="co"># make labels lower case</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>empirical_data<span class="sc">$</span>taxon <span class="ot">&lt;-</span> <span class="fu">tolower</span>(empirical_data<span class="sc">$</span>taxon)</span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a><span class="co"># clean up a few names because I'm a grub</span></span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(empirical_data)[<span class="fu">which</span>(<span class="fu">colnames</span>(empirical_data) <span class="sc">==</span> <span class="st">"taxon"</span>)] <span class="ot">&lt;-</span> <span class="st">"m"</span></span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(empirical_data)[<span class="fu">which</span>(<span class="fu">colnames</span>(empirical_data)<span class="sc">==</span><span class="st">"rs_kutosis"</span>)] <span class="ot">&lt;-</span> <span class="st">"rs_kurtosis"</span></span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(empirical_data)[<span class="fu">which</span>(<span class="fu">colnames</span>(empirical_data)<span class="sc">==</span><span class="st">"n_species"</span>)] <span class="ot">&lt;-</span> <span class="st">"n_extant_diversity"</span></span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(empirical_data) <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"_p_cor"</span>, <span class="st">"_cor"</span>,<span class="fu">colnames</span>(empirical_data)) <span class="co"># change _p_cor for posterior samplescould also change _m_cor to use MCC samples</span></span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(empirical_data) <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"DivRate"</span>, <span class="st">"DR"</span>,<span class="fu">colnames</span>(empirical_data))</span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(empirical_data)[<span class="fu">which</span>(<span class="fu">colnames</span>(empirical_data) <span class="sc">==</span> <span class="st">"taxon"</span>)] <span class="ot">&lt;-</span> <span class="st">"m"</span></span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(empirical_data)[<span class="fu">which</span>(<span class="fu">colnames</span>(empirical_data) <span class="sc">==</span> <span class="st">"collessI_posterior"</span>)] <span class="ot">&lt;-</span> <span class="st">"collessI"</span></span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(empirical_data)[<span class="fu">which</span>(<span class="fu">colnames</span>(empirical_data) <span class="sc">==</span> <span class="st">"sackinI_mcc"</span>)] <span class="ot">&lt;-</span> <span class="st">"sackinI"</span></span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(empirical_data)[<span class="fu">which</span>(<span class="fu">colnames</span>(empirical_data) <span class="sc">==</span> <span class="st">"gamma_mcc"</span>)] <span class="ot">&lt;-</span> <span class="st">"gamma"</span></span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-21"><a href="#cb72-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-22"><a href="#cb72-22" aria-hidden="true" tabindex="-1"></a><span class="co"># ok these should be able to be matched now</span></span>
<span id="cb72-23"><a href="#cb72-23" aria-hidden="true" tabindex="-1"></a>empirical_data <span class="ot">&lt;-</span> empirical_data[, <span class="fu">which</span>(<span class="fu">colnames</span>(empirical_data) <span class="sc">%in%</span> <span class="fu">colnames</span>(sim_data_ms))]</span>
<span id="cb72-24"><a href="#cb72-24" aria-hidden="true" tabindex="-1"></a>empirical_subset <span class="ot">&lt;-</span> empirical_data[, <span class="fu">match</span>(<span class="fu">colnames</span>(sim_data_ms), <span class="fu">colnames</span>(empirical_data))]</span>
<span id="cb72-25"><a href="#cb72-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-26"><a href="#cb72-26" aria-hidden="true" tabindex="-1"></a><span class="co"># check names match</span></span>
<span id="cb72-27"><a href="#cb72-27" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(sim_data_ms)[<span class="fu">which</span>(<span class="sc">!</span><span class="fu">colnames</span>(sim_data_ms) <span class="sc">%in%</span> <span class="fu">colnames</span>(empirical_subset))]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>character(0)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(empirical_subset)[<span class="fu">which</span>(<span class="sc">!</span><span class="fu">colnames</span>(empirical_subset) <span class="sc">%in%</span> <span class="fu">colnames</span>(sim_data_ms))]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>character(0)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(empirical_subset) <span class="sc">==</span> <span class="fu">colnames</span>(sim_data_ms)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE
[16] TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE
[31] TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Process empirical data in the same way as for the simulated data</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>simulated_transformed <span class="ot">&lt;-</span> <span class="fu">predict</span>(preprocessed_values, sim_data_ms )</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>empirical_transformed <span class="ot">&lt;-</span> <span class="fu">predict</span>(preprocessed_values, empirical_subset )</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>model_set <span class="ot">&lt;-</span> <span class="fu">list</span>(lda_train)</span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a><span class="co"># predict on empirical</span></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>class_predictions   <span class="ot">&lt;-</span> <span class="fu">predict</span>(model_set, <span class="at">newdata =</span> empirical_transformed, <span class="at">type =</span> <span class="st">"raw"</span>, <span class="at">na.action =</span> na.omit)</span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>class_probabilities <span class="ot">&lt;-</span> <span class="fu">predict</span>(model_set, <span class="at">newdata =</span> empirical_transformed, <span class="at">type =</span> <span class="st">"prob"</span>, <span class="at">na.action =</span> na.omit)</span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a><span class="co"># sum the classes</span></span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a><span class="fu">colSums</span>(<span class="fu">do.call</span>(rbind, class_predictions)) <span class="co"># </span><span class="al">TODO</span><span class="co"> define class prediction table</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 3 2 2 2 1 2 4 1 4 4 1 1 2 1 2 4 2 1 2 2 4 1 3 2 4 2 2 2 2 4 1 2 4 2 3 4 1 2
[39] 2 4 1 1 1 3 2 2 1 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co"># now we can see which model is the most supported for each order</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(empirical_transformed<span class="sc">$</span>m, <span class="fu">as.character</span>(class_predictions[[<span class="dv">1</span>]]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      [,1]                [,2]
 [1,] "serpentes"         "m2"
 [2,] "anguimorpha"       "m1"
 [3,] "dibamia"           "m1"
 [4,] "gekkota"           "m1"
 [5,] "iguania"           "m0"
 [6,] "lacertoidea"       "m1"
 [7,] "scincoidea"        "m3"
 [8,] "afrosoricida"      "m0"
 [9,] "carnivora"         "m3"
[10,] "cetartiodactyla"   "m3"
[11,] "chiroptera"        "m0"
[12,] "cingulata"         "m0"
[13,] "dasyuromorphia"    "m1"
[14,] "didelphimorphia"   "m0"
[15,] "diprotodontia"     "m1"
[16,] "eulipotyphla"      "m3"
[17,] "lagomorpha"        "m1"
[18,] "primates"          "m0"
[19,] "rodentia"          "m1"
[20,] "scandentia"        "m1"
[21,] "accipitriformes"   "m3"
[22,] "anseriformes"      "m0"
[23,] "apodiformes"       "m2"
[24,] "bucerotiformes"    "m1"
[25,] "caprimulgiformes"  "m3"
[26,] "charadriiformes"   "m1"
[27,] "columbiformes"     "m1"
[28,] "coraciiformes"     "m1"
[29,] "cuculiformes"      "m1"
[30,] "falconiformes"     "m3"
[31,] "galliformes"       "m0"
[32,] "gruiformes"        "m1"
[33,] "musophagiformes"   "m3"
[34,] "otidiformes"       "m1"
[35,] "passeriformes"     "m2"
[36,] "pelecaniformes"    "m3"
[37,] "piciformes"        "m0"
[38,] "procellariiformes" "m1"
[39,] "psittaciformes"    "m1"
[40,] "strigiformes"      "m3"
[41,] "suliformes"        "m0"
[42,] "tinamiformes"      "m0"
[43,] "trogoniformes"     "m0"
[44,] "anura"             "m2"
[45,] "caudata"           "m1"
[46,] "gymnophiona"       "m1"
[47,] "crocodylia"        "m0"
[48,] "testudines"        "m0"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(class_predictions[[<span class="dv">1</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
m0 m1 m2 m3 
14 20  4 10 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># can also look at the variation in this</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(empirical_transformed<span class="sc">$</span>m, <span class="fu">round</span>(class_probabilities[[<span class="dv">1</span>]], <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   empirical_transformed$m    m0    m1    m2    m3
1                serpentes 0.035 0.001 0.794 0.170
2              anguimorpha 0.002 0.880 0.000 0.117
3                  dibamia 0.000 0.998 0.000 0.002
4                  gekkota 0.001 0.997 0.000 0.002
5                  iguania 0.987 0.005 0.002 0.006
6              lacertoidea 0.028 0.971 0.000 0.001
7               scincoidea 0.003 0.076 0.025 0.896
8             afrosoricida 0.869 0.131 0.000 0.000
9                carnivora 0.003 0.031 0.007 0.958
10         cetartiodactyla 0.019 0.003 0.409 0.569
11              chiroptera 0.491 0.041 0.220 0.249
12               cingulata 0.750 0.089 0.000 0.160
13          dasyuromorphia 0.000 1.000 0.000 0.000
15         didelphimorphia 0.449 0.044 0.273 0.234
16           diprotodontia 0.000 1.000 0.000 0.000
17            eulipotyphla 0.005 0.310 0.009 0.676
19              lagomorpha 0.000 1.000 0.000 0.000
28                primates 0.994 0.000 0.004 0.001
30                rodentia 0.118 0.644 0.010 0.229
31              scandentia 0.000 1.000 0.000 0.000
33         accipitriformes 0.026 0.003 0.323 0.648
34            anseriformes 0.984 0.013 0.002 0.002
35             apodiformes 0.000 0.000 0.971 0.029
37          bucerotiformes 0.000 1.000 0.000 0.000
38        caprimulgiformes 0.000 0.000 0.129 0.871
41         charadriiformes 0.129 0.871 0.000 0.000
44           columbiformes 0.363 0.582 0.001 0.054
45           coraciiformes 0.008 0.874 0.000 0.119
46            cuculiformes 0.023 0.975 0.000 0.002
48           falconiformes 0.044 0.172 0.062 0.721
49             galliformes 0.952 0.047 0.000 0.001
51              gruiformes 0.091 0.903 0.000 0.006
53         musophagiformes 0.054 0.018 0.309 0.619
54             otidiformes 0.019 0.880 0.000 0.100
55           passeriformes 0.002 0.000 0.994 0.004
56          pelecaniformes 0.000 0.003 0.015 0.982
59              piciformes 0.997 0.002 0.000 0.001
61       procellariiformes 0.000 1.000 0.000 0.000
62          psittaciformes 0.008 0.991 0.000 0.002
66            strigiformes 0.007 0.013 0.217 0.763
67              suliformes 0.965 0.035 0.000 0.000
68            tinamiformes 1.000 0.000 0.000 0.000
69           trogoniformes 0.871 0.128 0.000 0.001
70                   anura 0.010 0.000 0.950 0.040
71                 caudata 0.000 0.973 0.000 0.027
72             gymnophiona 0.210 0.789 0.000 0.001
73              crocodylia 0.979 0.014 0.006 0.002
74              testudines 0.783 0.016 0.081 0.120</code></pre>
</div>
</div>
<p>What patterns do you see? Which models are the most supported?</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./Day1_Prac3_islands.html" class="pagination-link" aria-label="üèùÔ∏è Island Hopping">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">üèùÔ∏è Island Hopping</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./Day2_Prac5_landscapes.html" class="pagination-link" aria-label="üåã Creating Worlds">
        <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">üåã Creating Worlds</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>