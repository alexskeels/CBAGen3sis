{"title":"üñ•Ô∏è Silicodiversity","markdown":{"yaml":{"title":"üñ•Ô∏è Silicodiversity","author":"Alex Skeels and Oskar Hagen","execute":{"eval":true}},"headingText":"Exploring outputs","headingAttr":{"id":"","classes":["unnumbered"],"keyvalue":[]},"containsRefs":false,"markdown":"\n\n```{r setup, include=FALSE}\nknitr::opts_chunk$set(warning = FALSE, message = FALSE) \n```\n\n\nIn this practical we will explore the outputs from gen3sis using the island simulations we ran yesterday. We will learn how to use this data with common R packages for phylogenetic comparative methods, community phylogenetics, biogeography and much more.\n\nThe goal for today will be to produce:\n\n1.  A map of Species Richness from the simulation summary object\n\n2.  A plot of Lineages Through Time from the phylogeny\n\n3.  Plot of species trait values on a phylogenetic tree, by linking the species objects to the phylogeny\n\n4.  Maps of Phylogenetic Diversity by linking species objects to the landscape and phylogeny\n\nFirst, let's make sure we have the necessary packages loaded\n\n```{r}\nrequire(gen3sis)\nrequire(terra)\nrequire(ape)\nrequire(phytools)\nrequire(picante)\nrequire(here)\nsetwd(here())\n```\n\n#### Simulation summary object (sgen3sis.rds) {.unnumbered}\n\nThe first object we will look at today is the sgenesis.rds file. This file contains a summary of the simulation. Which we can plot (as we did yesterday) with the plot_summary function. This is the same object, that you would have in memory by running a simulation with run_simulation.\n\n```{r}\noutput_dir <- \"output/islands\" \n\nsim <- readRDS(file.path(output_dir, \"config_islands_simple_Day1Prac3_M3/sgen3sis.rds\")) \n\n# look at what the simulation summary contains\nnames(sim)\n```\n\nThe first element is the sim summary. This contains a record of the history of speciation, extinction, and species richness through time (phylo_summary), a history of the number of total grid cells occupied during the simulation through time (occupancy) and the species richness of each grid cell at the final time step.\n\n```{r}\nstr(sim$summary)\n\n# phylo summary\nhead(sim$summary$phylo_summary)\n\n# occupancy\nhead(sim$summary$occupancy)\n\n# occupancy\nhead(sim$summary$`richness-final`)\n```\n\nThese data can be visualized with the plot_summary function\n\n```{r}\n# Visualize the outputs \nplot_summary(sim)\n```\n\nWe can also use these data to map out patterns of species richness\n\n```{r}\n# make sure the landscape is loaded\nlc <- readRDS(file.path(\"data\", \"landscapes\", \"islands\",\"landscapes.rds\"))\n\n# can remove cells with elevation below sea level at timestep 0 (present-day) to see the outlines of the islands\nna_mask <- is.na(lc$elevation[,\"0\"])\nrich <- sim$summary$`richness-final`\nrich[na_mask,3] <- NA\n\n# turn richness summary into a raster \nrichness <- rast(rich, type=\"xyz\")\n\n# plot, the sea is darblue, given by hexadecimal color code \nplot(richness, col=c(\"grey\", gen3sis::color_richness(12)), colNA=\"#000033\")\n```\n\nThe next part of the simulation summary object is the flag which will tell us if the simulation ran successfully. It should give \"OK\"\n\n```{r}\nsim$flag\n```\n\nNext is the system summary. This is information about the R version, R packages, and operating system used in the simulation. This ensures complete repeatability. It also tells us the runtime of the simulation.\n\n```{r}\nsim$system\n```\n\nFinally the summary object contains the config information and model parameters used.\n\n```{r}\nsim$parameters\n```\n\n#### Phylogeny object (phy.nex) {.unnumbered}\n\nThe phylogeny object is pretty straight forward. It is a nexus file containing the relationships between the species.\n\n```{r}\n# read phy\nphy <- read.nexus(file.path(output_dir, \"config_islands_simple_Day1Prac3_M3/phy.nex\"))\n\n# plot phy\nplot(phy)\n```\n\nFrom this object we can look at lineages through time plots and estimate trends in diversification. The gamma statistic is one way to detect diversification slowdowns or speedups, with positive values indicating nodes are more closely pushed up towards the tips (speed up) and negative values indicating nodes are closer to the root (slowdown) ([Pybus and Harvey 2000](https://royalsocietypublishing.org/doi/10.1098/rspb.2000.1278)). There are lots of other kinds of measures of phylogenetic tree shape, such as metrics of tree imbalance (Colless's Index, Beta-Splitting Paramater, etc.)\n\n```{r}\n# plot an ltt\nltt_M1 <-ltt(phy)\n\n# look at the gamma statistic\nprint(paste0(\"Gamma = \", round(ltt_M1$gamma, 2)))\n\n# is there a significant deviation from constant rates?\nprint(paste0(\"P = \", round(ltt_M1$p, 2)))\n```\n\n#### Species objects (phy.nex) {.unnumbered}\n\nNow its time to get into the meat of the gen3sis outputs. Most of the information from the simulation is stored in the species objects. These are .rds files that contain a list which includes information on every species, extinct or extant, that existed during the simulation. These are saved per default at every time step, but can be fine tuned according to your needs. The naming convention is \"species_t_0.rds\" for time step 0 (present-day), and \"species_t_50\" for timestep 50, etc.\n\n```{r}\n# load object\nspecies_t_0 <- readRDS(file.path(output_dir, \"config_islands_simple_Day1Prac3_M3\", \"species\", \"species_t_0.rds\"))\n\n# look at object class and length\nclass(species_t_0)\nlength(species_t_0)\n\n# compare to number of tips in the phylogeny\nNtip(phy)\n```\n\nThere are 14 elements in the list, representing our 14 species and this number matches the number of species in our phylogeny. No species went extinct in this particular simulation, but if they did, they would match extinct tips in the phylogeny.\n\nLets look at a single species\n\n```{r}\nnames(species_t_0[[1]])\n\n\n```\n\nThe species has an ID which allows us to match it to the phylogeny.\n\n```{r}\nspecies_t_0[[1]]$id\n```\n\nThe species' abundances are also linked to grid cells in the landscape, which can be matched with their corresponding names.\n\n```{r}\nspecies_t_0[[1]]$abundance\n```\n\nIn this case the species has abundance values of 1 in all populations from the cells that it occupies. This is because we set abundances to be binary: 1=present, 0=absent. We can see the species occupies cells 247, 248, 249, etc.\n\nThe species also has values of it's traits for each of its populations.\n\n```{r}\nhead(species_t_0[[1]]$traits)\n```\n\nWe can see the population that each row is linked by the rownames. Here you can see 247, 248, 249, etc. Each of these populations have a dispersal trait of 5 (because we didn't vary this) slightly different temp_mean traits (because these evolved stochastically under a Brownian motion model) and a temp width of 1 (again, we didn;t vary this in model 1).\n\nSo, if we want to map out the distribution of species 1 at timestep 0, we just need to link those cell names (267/268/etc) to the landscape object and make a raster. Why don;t we try and see what islands species 1 is found on.\n\n```{r}\npar(mfrow=c(1,3))\n# first plot the islands out from the landscape object\npatch_xyz <- rast(lc$patch[,c(\"x\", \"y\", \"0\")], type=\"xyz\")\nplot(patch_xyz, main=\"Island Patches\", col=palette()[c(2,3,4,6)], colNA=\"#000033\")\n\n# pull out values of the landscape where the species is found\nspecies1_xyz <- lc$patch[which(rownames(lc$patch) %in% rownames(species_t_0[[1]]$traits)), c(\"x\", \"y\", \"0\")]\n\n# turn it into a raster\nspecies1_xyz <- rast(species1_xyz, type=\"xyz\")\nspecies1_xyz <- extend(species1_xyz, patch_xyz)\nplot(species1_xyz, main= \"Species 1 Distribution\", colNA=\"#000033\")\n\n# alternatively we can use the plot_species function on gen3sis..\n# for that we load the landscape object of the respective time-step\nlandscape_t_0 <- readRDS(file.path(output_dir, \"config_islands_simple_Day1Prac3_M1\", \"landscapes\", \"landscape_t_0.rds\"))\ngen3sis::plot_species_presence(species_t_0[[1]], landscape_t_0)\n\n```\n\n#### Linking the species object and phylogeny {.unnumbered}\n\nLets try and link the species trait data to the phylogeny to start learning something about what exactly took place during our simulation! Let's get the mean trait value of the temperature niche and also the islands that each species belongs too.\n\n```{r}\n# lets create a data frame\ndaf <- data.frame(\"id\"= paste0(\"species\",sapply(species_t_0, function(x)x$id)),\n                 \"mean_temp\"=NA,\n                 \"island1\"=0,\n                 \"island2\"=0,\n                 \"island3\"=0,\n                 \"island4\"=0, \n                 \"island_start\"=NA)\n\n# take a look\nhead(daf)\n\n# Use sapply on the species object to get their mean trait values\ndaf$mean_temp <- sapply(species_t_0, function(x){\n  # x <- species_t_0[[1]]\n  mean(x$traits[, \"temp_niche_centre\"], na.rm=T)\n  })\n\n# Get the island patch id values in a for loop\nfor(i in 1:length(species_t_0)){\n  #I'm here because it is a good idea to test code on a single species before running it on all species\n  # i <- 1 \n  # as before we get the lanscape values of each species\n  speciesi_xyz <- lc$patch[which(rownames(lc$patch) %in% rownames(species_t_0[[i]]$traits)), c(\"x\", \"y\", \"0\")]\n  \n  # then pull out the unique values (note that species might occur on more than one island)\n  islands <- unique(speciesi_xyz[, 3])\n  \n  # then if species are on the island, give that column a value of 1\n  \n  daf$island1[i] <- ifelse(1 %in% islands, 1, 0)\n  daf$island2[i] <- ifelse(2 %in% islands, 1, 0)\n  daf$island3[i] <- ifelse(3 %in% islands, 1, 0)\n  daf$island4[i] <- ifelse(4 %in% islands, 1, 0)\n}\n\n# get the starting island from the traits object since we recorded this in the initialization step\ndaf$island_start <- sapply(species_t_0, function(xasa) unique(xasa$traits[, \"start_island\"]))\n```\n\nNow look again at the data frame\n\n```{r}\nhead(daf)\n```\n\nPlot out the continuously evolving temperature niche trait\n\n```{r}\n\n# create a named vector for the log of the temperature niche trait\ntemp_niche <- daf$mean_temp\nnames(temp_niche) <- daf$id\n\n# plot it out with dots = trait\ndotTree(phy,temp_niche,ftype=\"i\", length=8, fsize=1.2, standardize=T)\n```\n\nNot much variation in that trait, due to the combined effects of trait homogenization and a low rate of change. Lets plot the tip states of the islands on the phylogeny using the phytools package\n\n```{r}\npar(mfrow=c(1,2))\n\n# format each island\nformatIsland <- function(island, phy=phy, daf=daf){\n  islandf <- as.factor(daf[, island])\n  names(islandf) <- daf$id\n  islandmat<-to.matrix(islandf,levels(islandf))\n  islandmat<-islandmat[phy$tip.label,]\n  return(list(islandf, islandmat))\n}\n\n\nplotTree(phy,ftype=\"i\",offset=1,fsize=0.9, xlim=c(0, 75))\n\ntiplabels(pie=formatIsland(island=\"island1\", phy=phy, daf=daf)[[2]],piecol=palette()[c(8,2)],cex=0.6, adj=12+1)\ntiplabels(pie=formatIsland(island=\"island2\", phy=phy, daf=daf)[[2]],piecol=palette()[c(8,3)],cex=0.6, adj=12+3)\ntiplabels(pie=formatIsland(island=\"island3\", phy=phy, daf=daf)[[2]],piecol=palette()[c(8,4)],cex=0.6, adj=12+5)\ntiplabels(pie=formatIsland(island=\"island4\", phy=phy, daf=daf)[[2]],piecol=palette()[c(8,6)],cex=0.6, adj=12+7)\n\nplot(patch_xyz, main=\"Island Patches\", col=palette()[c(2,3,4,6)])\n```\n\nInteresting. What do you notice about the distribution of species on islands? Could you predict which island each lineage began on?\n\nWe actually know which islands each lineage started on because we recorded this as a trait (we could also look at the past species objects to figure this out but we have used a shortcut though the traits).\n\n```{r}\n\npar(mfrow=c(1,2))\nplotTree(phy,ftype=\"i\",offset=1,fsize=0.4, xlim=c(0, 75))\nmy_cex=1.2\ntiplabels(pie=formatIsland(island=\"island1\", phy=phy, daf=daf)[[2]],piecol=palette()[c(8,2)],cex=my_cex, adj=12+1)\ntiplabels(pie=formatIsland(island=\"island2\", phy=phy, daf=daf)[[2]],piecol=palette()[c(8,3)],cex=my_cex, adj=12+3)\ntiplabels(pie=formatIsland(island=\"island3\", phy=phy, daf=daf)[[2]],piecol=palette()[c(8,4)],cex=my_cex, adj=12+5)\ntiplabels(pie=formatIsland(island=\"island4\", phy=phy, daf=daf)[[2]],piecol=palette()[c(8,6)],cex=my_cex, adj=12+7)\n\n# add the starting island as a fifth colum\ntiplabels(pie=formatIsland(island=\"island_start\", phy=phy, daf=daf)[[2]],piecol=palette()[c(2,3,4,6)],cex=1.6, adj=12+9, pch=7)\n\n# add island plot\nplot(patch_xyz, main=\"Island Patches\", col=palette()[c(2,3,4,6)])\n```\n\nSo whats really apparent here is that the clade that originated on the green island has speciated allopatrically into the red island multiple times in the recent past. The same is true for the red clade, however the deeper divergence between species9 and species3 have had enough time to recolonize both islands.\n\n#### Linking the species object, landscape, and phylogeny\n\nCommon spatial biodiversity analyses link information measured at the species level to maps of their distribution in space using presence-absence matrices or PAMs. PAMs typically are data frame with each row representing a site, could be an island or could be a grid cell, and each column representing a species. Values of 1 are given if the species is present in the site, if not a value of 0 is given.\n\n```{r}\n# grid cell level PAM\n\n# create an empty data frame with the dimensions of species x sites\nPAM <- data.frame(matrix(0, nrow=nrow(lc$elevation), ncol=length(species_t_0)))\n\n# given names to rows and columns\nrownames(PAM) <- rownames(lc$elevation)\ncolnames(PAM) <- paste0(\"species\", sapply(species_t_0, function(x)x$id))\n\n# loop over species and add value of 1 to all sites the species is present\nfor(i in 1:length(species_t_0)){\n  \n  PAM[which(rownames(PAM) %in% names(species_t_0[[i]]$abundance)), i] <- 1\n}\n\n# how does it look?\nprint(PAM[1:10, 1:10])\n```\n\n```{r}\n# we can estimate Phylogenetic diversity\npd_islands <- pd(PAM, phy)\n\n# we can also measure mean phylogenetic distance and mean nearest neighbour distance\nmpd_islands <- mpd(PAM, cophenetic(phy))\nmntd_islands <- mntd(PAM,cophenetic(phy))\n\n# link these back with the landscape by joining to the landscape lat/long\ncommunity_phylo <- cbind(lc$elevation[, c(\"x\", \"y\")], pd_islands, mpd_islands, mntd_islands)\n\npar(mfrow=c(2,2))\nsr_ras <- rast(community_phylo[, c(\"x\", \"y\", \"SR\")], type=\"xyz\")\npd_ras <- rast(community_phylo[, c(\"x\", \"y\", \"PD\")], type=\"xyz\")\nmpd_ras <- rast(community_phylo[, c(\"x\", \"y\", \"mpd_islands\")], type=\"xyz\")\nmntd_ras <- rast(community_phylo[, c(\"x\", \"y\", \"mntd_islands\")], type=\"xyz\")\n\nplot(sr_ras, main=\"Species Richness\", na.color =\"red\")\nplot(pd_ras, main=\"Phylogenetic Diversity\")\nplot(mpd_ras, main=\"Mean Phylogenetic Pairwise Distance\")\nplot(mntd_ras, main= \"Mean Nearest Neighbour Phylogenetic Distance\")\n```\n\n## Sensitivity analysis {.unnumbered}\n\nIn this part we are going to load in a data set from Skeels et al. (2022) *SystBiol* in which we simulated data with Gen3sis under four alternative models to test the evolutionary speed hypothesis (ESH). The ESH hypothesizes that faster rates of evolution occurs in lineages from warm regions like the tropics because they are have higher mutagenesis from faster life histories associated with warm temperatures and smaller body sizes. The four models used there were\n\n-   M0 - the null. population divergence is independent of temperature and body size\n\n-   M1 - Temperature Trailblazer. environmental temperature drives rate of population divergence\n\n-   M2 - Size Shaper. body size drives the rate of population divergence\n\n-   M3 - Synergistic Drivers. environmental temperature and body size drives the rate of population divergence\n\n![Skeels et al. 2022 Syst. Biol. Figure 1](figures/systbiol_fig1.jpeg)\n\nNot only did we change the overall model of evolution, we also varied key parameters for rates of niche evolution (simga_squared_t), rates of body size evolution (sigma_squared_bs), dispersal, and the temperature niche breadth (omega), the exponent of the divergence factor with temp/body size (lambda), and the divergence threshold. Load in the data and take a look, the first 6 columns are the model parameters we varied.\n\n```{r}\nsim_data <- read.csv(\"data/simulated_summary_statistics.csv\")\n\n# look at the first few columns\nhead(sim_data)\n\n# look at the models\nunique(sim_data$m)\n```\n\nThis data set has 27 metrics used in our paper to measure patterns in the distribution of species, such as range size metrics, or correlations between temperature and diversity, as well as phylogenetic tree shape metrics, such as gamma, and measures of functional diversity, like body size variance. We predicted that these different models of evolution (M0-M4) should leave discernible signatures in these metrics. We can plot a few associations between biodiversity metrics and these model parameters to test this hypothesis.\n\n```{r}\nrequire(ggplot2)\n\n# how is diversity related to the dispersal ability of a clade?\nggplot(sim_data, aes(x=m, y=log(n_extant_diversity), fill=m))+\n  geom_point(alpha=0.7, position = \"jitter\")+\n  geom_boxplot(alpha=0.7)+\n  stat_smooth()+\n  theme_classic()\n\n# how about the temperature~diversity gradient?\nggplot(sim_data, aes(x=m, y=richness_temp0mya_cor, fill=m))+\n  geom_point(alpha=0.7, position = \"jitter\")+\n  geom_boxplot(alpha=0.7)+\n  stat_smooth()+\n  theme_classic()\n\n# how about the relationship between  body size and diversification rate?\nggplot(sim_data, aes(x=m, y=bodysize_DR_cor, fill=m))+\n  geom_point(alpha=0.7, position = \"jitter\")+\n  geom_boxplot(alpha=0.7)+\n  stat_smooth()+\n  theme_classic()\n\n# how about the relationship between temperature and diversification rate?\nggplot(sim_data, aes(x=m, y=temp_DR_cor, fill=m))+\n  geom_point(alpha=0.7, position = \"jitter\")+\n  geom_boxplot(alpha=0.7)+\n  stat_smooth()+\n  theme_classic()\n```\n\nDo these patterns fit our predictions? We can also look at how some of these metrics varied with the continuous model parameters such as dispersal ability.\n\n```{r}\n# how is diversity related to the dispersal ability of a clade?\nggplot(sim_data, aes(x=dispersal, y=log(n_extant_diversity)))+\n  geom_point(alpha=0.7)+\n  stat_smooth()+\n  theme_classic()\n\n# how about the latitude diversity gradient?\nggplot(sim_data, aes(x=dispersal, y=temp_DR_cor))+\n  geom_point(alpha=0.7)+\n  stat_smooth()+\n  theme_classic()\n```\n\nTo perform a simple kind of sensitivity test we might ask how each of the model parameters predicts linear changes in the distribution of a biodiversity patterns using a multiple regression model. One example where we have a good idea of what the relationship should be is the how variance in the distribution of temperature niches across species (e.g., skewness of the distribution) relates to model paramaters. We expect that this should scale with the rate of rate of temperature niche evolution - faster rates of change = more variation in the trait = more kutosis.\n\n```{r}\n\n# first scale parameters to be in the same units\nsim_data_scaled <- sim_data\nsim_data_scaled[,1:6] <- scale(sim_data_scaled[,1:6] )\n\n# fit the multiple regression\nlm1  <- lm(temp_kurtosis ~ divergence_threshold+lambda+omega+sigma_squared_bs+sigma_squared_t+dispersal, data=sim_data_scaled)\n\n# look at model coefficients\nsummary(lm1)\n```\n\nWhat do you see? Are our expectations met? Any surprises? Let's try a few other biodiversity patterns where the predictions are less clear.\n\n```{r}\n# fit the multiple regressions\n\n# Gamma statsitic for phylogenetic tree shape\nlm2  <- lm(gamma ~ divergence_threshold+lambda+omega+sigma_squared_bs+sigma_squared_t+dispersal, data=sim_data_scaled)\n\n# skewness of the range size distribution of species\nlm3  <- lm(rs_skewness ~ divergence_threshold+lambda+omega+sigma_squared_bs+sigma_squared_t+dispersal, data=sim_data_scaled)\n\n# correlation between species range sizes and temperature\nlm4  <- lm(rangesize_temp_cor ~ divergence_threshold+lambda+omega+sigma_squared_bs+sigma_squared_t+dispersal, data=sim_data_scaled)\n\n# look at model coefficients\nsummary(lm2)\nsummary(lm3)\nsummary(lm4)\n```\n\nIn all these cases there are interesting associations between model parameters and the biodiversity metrics. However, look at the R-squared values and what do you find? They are highly variable and in some cases quite low. This means that lots of variance in these biodiversity metrics are not explained by a linear combination of our model parameters. This is important when interpreting the effect. There are other ways of inferring more complex relationships between model parameters and biodiversity metrics, such as by including quadratic effects, exploring interaction terms, fitting non-linear models such as generalised additive models (GAMs), or even using machine learning methods such as neural networks which allow for highly-dimension non-linear effects. We won't cover these today but they are all useful options to explore during sensitivity analysis.\n\n### Model Selection\n\nOnce we have established that some biodiversity metrics showed predictable relationships with model parameters or the generative model (e.g., M0-M4) we can use these metrics to perform model selection on empirical data. Here we are using the match between observed biodiversity patterns and simulated biodiversity patterns, to ask which model might be most likely to have generated the real patterns.\n\n![Skeels et al. 2022 Syst. Biol. Figure 2](figures/systbiol_fig2.jpeg)\n\nTo do this we are going to perform a linear discriminant analysis which is a classification tool that can fit fit fairly quickly compared to some of the other models. We want to validate how well the model performs so we will perform a 10-fold cross validation repeated 10 times. Here we train the model on a subset of the data, repeating the process and optimising the predictive capacity. Then we predict how good a job our classifier is on a witheld portion of the data (test data). If the model performs well we should be able to accurately predict what models generated what biodiversity metrics.\n\n```{r}\nrequire(caret)\n# get just the biodiversity metrics\nsim_data_ms <- sim_data[,7:ncol(sim_data)]\n\n# remove MRDs variables from sim data\nsim_data_ms <- sim_data_ms[, -which(grepl(\"MRDs\",colnames(sim_data_ms)))]\n\n# partition into a training and testing dataset for cross validation\ntrain_index <- createDataPartition(sim_data_ms$m, p = .66, list = FALSE,  times = 1)\ntrain_data <- sim_data_ms[ train_index ,]\ntest_data  <- sim_data_ms[-train_index ,]\n\n# preprocess values - we will scale and center values\npreprocessed_values <- preProcess(train_data, method = c(\"center\", \"scale\"))\ntrain_transformed   <- predict(preprocessed_values, train_data)\ntest_transformed    <- predict(preprocessed_values, test_data )\n\n# configure the cross-validation paramaters\ntrain_control <- trainControl( method = \"repeatedcv\", number = 10, repeats = 10, classProbs = TRUE, savePredictions = TRUE)\n\n# FIT MODELS\nf1 <- formula(paste(\"m ~ \", paste(names(sim_data_ms)[2:c(length(names(sim_data_ms)))], collapse=\" + \")))\n\n## LINEAR DISCRIMINANT ANALYSIS\n# note we'll run an LDA because they're quick - many other kinds of models to choose from \nlda_train        <- train(f1, data=train_transformed, method = \"lda\", trControl = train_control, verbose = T)\n\n#predict on test data\nlda_test        <- predict(lda_train, test_transformed)\n\n# classification accuracy\nlda_cm        <- confusionMatrix(data = lda_test, reference = as.factor(test_transformed$m), mode = \"prec_recall\")\n\n# how well did the model perform\nlda_cm \n\n```\n\nWhats the overall accuracy? Are some models predicted better than others?\n\nNow we'll use this model to predict the possible model of diversification in orders of terrestrial vertebrates.\n\n```{r, eval=TRUE}\n# first subset and clean the colnames of the empirical data\nempirical_data <- read.csv(\"data/order_empirical_summary_statistics.csv\")\n\n# just want to look at diverse clades\nempirical_data <- na.omit(empirical_data[which(empirical_data$n_species >= 20),])\n\n# make labels lower case\nempirical_data$taxon <- tolower(empirical_data$taxon)\n\n# clean up a few names because I'm a grub\ncolnames(empirical_data)[which(colnames(empirical_data) == \"taxon\")] <- \"m\"\ncolnames(empirical_data)[which(colnames(empirical_data)==\"rs_kutosis\")] <- \"rs_kurtosis\"\ncolnames(empirical_data)[which(colnames(empirical_data)==\"n_species\")] <- \"n_extant_diversity\"\ncolnames(empirical_data) <- gsub(\"_p_cor\", \"_cor\",colnames(empirical_data)) # change _p_cor for posterior samplescould also change _m_cor to use MCC samples\ncolnames(empirical_data) <- gsub(\"DivRate\", \"DR\",colnames(empirical_data))\ncolnames(empirical_data)[which(colnames(empirical_data) == \"taxon\")] <- \"m\"\ncolnames(empirical_data)[which(colnames(empirical_data) == \"collessI_posterior\")] <- \"collessI\"\ncolnames(empirical_data)[which(colnames(empirical_data) == \"sackinI_mcc\")] <- \"sackinI\"\ncolnames(empirical_data)[which(colnames(empirical_data) == \"gamma_mcc\")] <- \"gamma\"\n\n\n# ok these should be able to be matched now\nempirical_data <- empirical_data[, which(colnames(empirical_data) %in% colnames(sim_data_ms))]\nempirical_subset <- empirical_data[, match(colnames(sim_data_ms), colnames(empirical_data))]\n\n# check names match\ncolnames(sim_data_ms)[which(!colnames(sim_data_ms) %in% colnames(empirical_subset))]\ncolnames(empirical_subset)[which(!colnames(empirical_subset) %in% colnames(sim_data_ms))]\ncolnames(empirical_subset) == colnames(sim_data_ms)\n\n# Process empirical data in the same way as for the simulated data\nsimulated_transformed <- predict(preprocessed_values, sim_data_ms )\nempirical_transformed <- predict(preprocessed_values, empirical_subset )\n\nmodel_set <- list(lda_train)\n\n# predict on empirical\nclass_predictions   <- predict(model_set, newdata = empirical_transformed, type = \"raw\", na.action = na.omit)\nclass_probabilities <- predict(model_set, newdata = empirical_transformed, type = \"prob\", na.action = na.omit)\n\n# sum the classes\ncolSums(do.call(rbind, class_predictions)) # TODO define class prediction table\n\n# now we can see which model is the most supported for each order\ncbind(empirical_transformed$m, as.character(class_predictions[[1]]))\n\ntable(class_predictions[[1]])\n\n# can also look at the variation in this\ncbind(empirical_transformed$m, round(class_probabilities[[1]], 3))\n```\n\nWhat patterns do you see? Which models are the most supported?\n","srcMarkdownNoYaml":"\n\n```{r setup, include=FALSE}\nknitr::opts_chunk$set(warning = FALSE, message = FALSE) \n```\n\n## Exploring outputs {.unnumbered}\n\nIn this practical we will explore the outputs from gen3sis using the island simulations we ran yesterday. We will learn how to use this data with common R packages for phylogenetic comparative methods, community phylogenetics, biogeography and much more.\n\nThe goal for today will be to produce:\n\n1.  A map of Species Richness from the simulation summary object\n\n2.  A plot of Lineages Through Time from the phylogeny\n\n3.  Plot of species trait values on a phylogenetic tree, by linking the species objects to the phylogeny\n\n4.  Maps of Phylogenetic Diversity by linking species objects to the landscape and phylogeny\n\nFirst, let's make sure we have the necessary packages loaded\n\n```{r}\nrequire(gen3sis)\nrequire(terra)\nrequire(ape)\nrequire(phytools)\nrequire(picante)\nrequire(here)\nsetwd(here())\n```\n\n#### Simulation summary object (sgen3sis.rds) {.unnumbered}\n\nThe first object we will look at today is the sgenesis.rds file. This file contains a summary of the simulation. Which we can plot (as we did yesterday) with the plot_summary function. This is the same object, that you would have in memory by running a simulation with run_simulation.\n\n```{r}\noutput_dir <- \"output/islands\" \n\nsim <- readRDS(file.path(output_dir, \"config_islands_simple_Day1Prac3_M3/sgen3sis.rds\")) \n\n# look at what the simulation summary contains\nnames(sim)\n```\n\nThe first element is the sim summary. This contains a record of the history of speciation, extinction, and species richness through time (phylo_summary), a history of the number of total grid cells occupied during the simulation through time (occupancy) and the species richness of each grid cell at the final time step.\n\n```{r}\nstr(sim$summary)\n\n# phylo summary\nhead(sim$summary$phylo_summary)\n\n# occupancy\nhead(sim$summary$occupancy)\n\n# occupancy\nhead(sim$summary$`richness-final`)\n```\n\nThese data can be visualized with the plot_summary function\n\n```{r}\n# Visualize the outputs \nplot_summary(sim)\n```\n\nWe can also use these data to map out patterns of species richness\n\n```{r}\n# make sure the landscape is loaded\nlc <- readRDS(file.path(\"data\", \"landscapes\", \"islands\",\"landscapes.rds\"))\n\n# can remove cells with elevation below sea level at timestep 0 (present-day) to see the outlines of the islands\nna_mask <- is.na(lc$elevation[,\"0\"])\nrich <- sim$summary$`richness-final`\nrich[na_mask,3] <- NA\n\n# turn richness summary into a raster \nrichness <- rast(rich, type=\"xyz\")\n\n# plot, the sea is darblue, given by hexadecimal color code \nplot(richness, col=c(\"grey\", gen3sis::color_richness(12)), colNA=\"#000033\")\n```\n\nThe next part of the simulation summary object is the flag which will tell us if the simulation ran successfully. It should give \"OK\"\n\n```{r}\nsim$flag\n```\n\nNext is the system summary. This is information about the R version, R packages, and operating system used in the simulation. This ensures complete repeatability. It also tells us the runtime of the simulation.\n\n```{r}\nsim$system\n```\n\nFinally the summary object contains the config information and model parameters used.\n\n```{r}\nsim$parameters\n```\n\n#### Phylogeny object (phy.nex) {.unnumbered}\n\nThe phylogeny object is pretty straight forward. It is a nexus file containing the relationships between the species.\n\n```{r}\n# read phy\nphy <- read.nexus(file.path(output_dir, \"config_islands_simple_Day1Prac3_M3/phy.nex\"))\n\n# plot phy\nplot(phy)\n```\n\nFrom this object we can look at lineages through time plots and estimate trends in diversification. The gamma statistic is one way to detect diversification slowdowns or speedups, with positive values indicating nodes are more closely pushed up towards the tips (speed up) and negative values indicating nodes are closer to the root (slowdown) ([Pybus and Harvey 2000](https://royalsocietypublishing.org/doi/10.1098/rspb.2000.1278)). There are lots of other kinds of measures of phylogenetic tree shape, such as metrics of tree imbalance (Colless's Index, Beta-Splitting Paramater, etc.)\n\n```{r}\n# plot an ltt\nltt_M1 <-ltt(phy)\n\n# look at the gamma statistic\nprint(paste0(\"Gamma = \", round(ltt_M1$gamma, 2)))\n\n# is there a significant deviation from constant rates?\nprint(paste0(\"P = \", round(ltt_M1$p, 2)))\n```\n\n#### Species objects (phy.nex) {.unnumbered}\n\nNow its time to get into the meat of the gen3sis outputs. Most of the information from the simulation is stored in the species objects. These are .rds files that contain a list which includes information on every species, extinct or extant, that existed during the simulation. These are saved per default at every time step, but can be fine tuned according to your needs. The naming convention is \"species_t_0.rds\" for time step 0 (present-day), and \"species_t_50\" for timestep 50, etc.\n\n```{r}\n# load object\nspecies_t_0 <- readRDS(file.path(output_dir, \"config_islands_simple_Day1Prac3_M3\", \"species\", \"species_t_0.rds\"))\n\n# look at object class and length\nclass(species_t_0)\nlength(species_t_0)\n\n# compare to number of tips in the phylogeny\nNtip(phy)\n```\n\nThere are 14 elements in the list, representing our 14 species and this number matches the number of species in our phylogeny. No species went extinct in this particular simulation, but if they did, they would match extinct tips in the phylogeny.\n\nLets look at a single species\n\n```{r}\nnames(species_t_0[[1]])\n\n\n```\n\nThe species has an ID which allows us to match it to the phylogeny.\n\n```{r}\nspecies_t_0[[1]]$id\n```\n\nThe species' abundances are also linked to grid cells in the landscape, which can be matched with their corresponding names.\n\n```{r}\nspecies_t_0[[1]]$abundance\n```\n\nIn this case the species has abundance values of 1 in all populations from the cells that it occupies. This is because we set abundances to be binary: 1=present, 0=absent. We can see the species occupies cells 247, 248, 249, etc.\n\nThe species also has values of it's traits for each of its populations.\n\n```{r}\nhead(species_t_0[[1]]$traits)\n```\n\nWe can see the population that each row is linked by the rownames. Here you can see 247, 248, 249, etc. Each of these populations have a dispersal trait of 5 (because we didn't vary this) slightly different temp_mean traits (because these evolved stochastically under a Brownian motion model) and a temp width of 1 (again, we didn;t vary this in model 1).\n\nSo, if we want to map out the distribution of species 1 at timestep 0, we just need to link those cell names (267/268/etc) to the landscape object and make a raster. Why don;t we try and see what islands species 1 is found on.\n\n```{r}\npar(mfrow=c(1,3))\n# first plot the islands out from the landscape object\npatch_xyz <- rast(lc$patch[,c(\"x\", \"y\", \"0\")], type=\"xyz\")\nplot(patch_xyz, main=\"Island Patches\", col=palette()[c(2,3,4,6)], colNA=\"#000033\")\n\n# pull out values of the landscape where the species is found\nspecies1_xyz <- lc$patch[which(rownames(lc$patch) %in% rownames(species_t_0[[1]]$traits)), c(\"x\", \"y\", \"0\")]\n\n# turn it into a raster\nspecies1_xyz <- rast(species1_xyz, type=\"xyz\")\nspecies1_xyz <- extend(species1_xyz, patch_xyz)\nplot(species1_xyz, main= \"Species 1 Distribution\", colNA=\"#000033\")\n\n# alternatively we can use the plot_species function on gen3sis..\n# for that we load the landscape object of the respective time-step\nlandscape_t_0 <- readRDS(file.path(output_dir, \"config_islands_simple_Day1Prac3_M1\", \"landscapes\", \"landscape_t_0.rds\"))\ngen3sis::plot_species_presence(species_t_0[[1]], landscape_t_0)\n\n```\n\n#### Linking the species object and phylogeny {.unnumbered}\n\nLets try and link the species trait data to the phylogeny to start learning something about what exactly took place during our simulation! Let's get the mean trait value of the temperature niche and also the islands that each species belongs too.\n\n```{r}\n# lets create a data frame\ndaf <- data.frame(\"id\"= paste0(\"species\",sapply(species_t_0, function(x)x$id)),\n                 \"mean_temp\"=NA,\n                 \"island1\"=0,\n                 \"island2\"=0,\n                 \"island3\"=0,\n                 \"island4\"=0, \n                 \"island_start\"=NA)\n\n# take a look\nhead(daf)\n\n# Use sapply on the species object to get their mean trait values\ndaf$mean_temp <- sapply(species_t_0, function(x){\n  # x <- species_t_0[[1]]\n  mean(x$traits[, \"temp_niche_centre\"], na.rm=T)\n  })\n\n# Get the island patch id values in a for loop\nfor(i in 1:length(species_t_0)){\n  #I'm here because it is a good idea to test code on a single species before running it on all species\n  # i <- 1 \n  # as before we get the lanscape values of each species\n  speciesi_xyz <- lc$patch[which(rownames(lc$patch) %in% rownames(species_t_0[[i]]$traits)), c(\"x\", \"y\", \"0\")]\n  \n  # then pull out the unique values (note that species might occur on more than one island)\n  islands <- unique(speciesi_xyz[, 3])\n  \n  # then if species are on the island, give that column a value of 1\n  \n  daf$island1[i] <- ifelse(1 %in% islands, 1, 0)\n  daf$island2[i] <- ifelse(2 %in% islands, 1, 0)\n  daf$island3[i] <- ifelse(3 %in% islands, 1, 0)\n  daf$island4[i] <- ifelse(4 %in% islands, 1, 0)\n}\n\n# get the starting island from the traits object since we recorded this in the initialization step\ndaf$island_start <- sapply(species_t_0, function(xasa) unique(xasa$traits[, \"start_island\"]))\n```\n\nNow look again at the data frame\n\n```{r}\nhead(daf)\n```\n\nPlot out the continuously evolving temperature niche trait\n\n```{r}\n\n# create a named vector for the log of the temperature niche trait\ntemp_niche <- daf$mean_temp\nnames(temp_niche) <- daf$id\n\n# plot it out with dots = trait\ndotTree(phy,temp_niche,ftype=\"i\", length=8, fsize=1.2, standardize=T)\n```\n\nNot much variation in that trait, due to the combined effects of trait homogenization and a low rate of change. Lets plot the tip states of the islands on the phylogeny using the phytools package\n\n```{r}\npar(mfrow=c(1,2))\n\n# format each island\nformatIsland <- function(island, phy=phy, daf=daf){\n  islandf <- as.factor(daf[, island])\n  names(islandf) <- daf$id\n  islandmat<-to.matrix(islandf,levels(islandf))\n  islandmat<-islandmat[phy$tip.label,]\n  return(list(islandf, islandmat))\n}\n\n\nplotTree(phy,ftype=\"i\",offset=1,fsize=0.9, xlim=c(0, 75))\n\ntiplabels(pie=formatIsland(island=\"island1\", phy=phy, daf=daf)[[2]],piecol=palette()[c(8,2)],cex=0.6, adj=12+1)\ntiplabels(pie=formatIsland(island=\"island2\", phy=phy, daf=daf)[[2]],piecol=palette()[c(8,3)],cex=0.6, adj=12+3)\ntiplabels(pie=formatIsland(island=\"island3\", phy=phy, daf=daf)[[2]],piecol=palette()[c(8,4)],cex=0.6, adj=12+5)\ntiplabels(pie=formatIsland(island=\"island4\", phy=phy, daf=daf)[[2]],piecol=palette()[c(8,6)],cex=0.6, adj=12+7)\n\nplot(patch_xyz, main=\"Island Patches\", col=palette()[c(2,3,4,6)])\n```\n\nInteresting. What do you notice about the distribution of species on islands? Could you predict which island each lineage began on?\n\nWe actually know which islands each lineage started on because we recorded this as a trait (we could also look at the past species objects to figure this out but we have used a shortcut though the traits).\n\n```{r}\n\npar(mfrow=c(1,2))\nplotTree(phy,ftype=\"i\",offset=1,fsize=0.4, xlim=c(0, 75))\nmy_cex=1.2\ntiplabels(pie=formatIsland(island=\"island1\", phy=phy, daf=daf)[[2]],piecol=palette()[c(8,2)],cex=my_cex, adj=12+1)\ntiplabels(pie=formatIsland(island=\"island2\", phy=phy, daf=daf)[[2]],piecol=palette()[c(8,3)],cex=my_cex, adj=12+3)\ntiplabels(pie=formatIsland(island=\"island3\", phy=phy, daf=daf)[[2]],piecol=palette()[c(8,4)],cex=my_cex, adj=12+5)\ntiplabels(pie=formatIsland(island=\"island4\", phy=phy, daf=daf)[[2]],piecol=palette()[c(8,6)],cex=my_cex, adj=12+7)\n\n# add the starting island as a fifth colum\ntiplabels(pie=formatIsland(island=\"island_start\", phy=phy, daf=daf)[[2]],piecol=palette()[c(2,3,4,6)],cex=1.6, adj=12+9, pch=7)\n\n# add island plot\nplot(patch_xyz, main=\"Island Patches\", col=palette()[c(2,3,4,6)])\n```\n\nSo whats really apparent here is that the clade that originated on the green island has speciated allopatrically into the red island multiple times in the recent past. The same is true for the red clade, however the deeper divergence between species9 and species3 have had enough time to recolonize both islands.\n\n#### Linking the species object, landscape, and phylogeny\n\nCommon spatial biodiversity analyses link information measured at the species level to maps of their distribution in space using presence-absence matrices or PAMs. PAMs typically are data frame with each row representing a site, could be an island or could be a grid cell, and each column representing a species. Values of 1 are given if the species is present in the site, if not a value of 0 is given.\n\n```{r}\n# grid cell level PAM\n\n# create an empty data frame with the dimensions of species x sites\nPAM <- data.frame(matrix(0, nrow=nrow(lc$elevation), ncol=length(species_t_0)))\n\n# given names to rows and columns\nrownames(PAM) <- rownames(lc$elevation)\ncolnames(PAM) <- paste0(\"species\", sapply(species_t_0, function(x)x$id))\n\n# loop over species and add value of 1 to all sites the species is present\nfor(i in 1:length(species_t_0)){\n  \n  PAM[which(rownames(PAM) %in% names(species_t_0[[i]]$abundance)), i] <- 1\n}\n\n# how does it look?\nprint(PAM[1:10, 1:10])\n```\n\n```{r}\n# we can estimate Phylogenetic diversity\npd_islands <- pd(PAM, phy)\n\n# we can also measure mean phylogenetic distance and mean nearest neighbour distance\nmpd_islands <- mpd(PAM, cophenetic(phy))\nmntd_islands <- mntd(PAM,cophenetic(phy))\n\n# link these back with the landscape by joining to the landscape lat/long\ncommunity_phylo <- cbind(lc$elevation[, c(\"x\", \"y\")], pd_islands, mpd_islands, mntd_islands)\n\npar(mfrow=c(2,2))\nsr_ras <- rast(community_phylo[, c(\"x\", \"y\", \"SR\")], type=\"xyz\")\npd_ras <- rast(community_phylo[, c(\"x\", \"y\", \"PD\")], type=\"xyz\")\nmpd_ras <- rast(community_phylo[, c(\"x\", \"y\", \"mpd_islands\")], type=\"xyz\")\nmntd_ras <- rast(community_phylo[, c(\"x\", \"y\", \"mntd_islands\")], type=\"xyz\")\n\nplot(sr_ras, main=\"Species Richness\", na.color =\"red\")\nplot(pd_ras, main=\"Phylogenetic Diversity\")\nplot(mpd_ras, main=\"Mean Phylogenetic Pairwise Distance\")\nplot(mntd_ras, main= \"Mean Nearest Neighbour Phylogenetic Distance\")\n```\n\n## Sensitivity analysis {.unnumbered}\n\nIn this part we are going to load in a data set from Skeels et al. (2022) *SystBiol* in which we simulated data with Gen3sis under four alternative models to test the evolutionary speed hypothesis (ESH). The ESH hypothesizes that faster rates of evolution occurs in lineages from warm regions like the tropics because they are have higher mutagenesis from faster life histories associated with warm temperatures and smaller body sizes. The four models used there were\n\n-   M0 - the null. population divergence is independent of temperature and body size\n\n-   M1 - Temperature Trailblazer. environmental temperature drives rate of population divergence\n\n-   M2 - Size Shaper. body size drives the rate of population divergence\n\n-   M3 - Synergistic Drivers. environmental temperature and body size drives the rate of population divergence\n\n![Skeels et al. 2022 Syst. Biol. Figure 1](figures/systbiol_fig1.jpeg)\n\nNot only did we change the overall model of evolution, we also varied key parameters for rates of niche evolution (simga_squared_t), rates of body size evolution (sigma_squared_bs), dispersal, and the temperature niche breadth (omega), the exponent of the divergence factor with temp/body size (lambda), and the divergence threshold. Load in the data and take a look, the first 6 columns are the model parameters we varied.\n\n```{r}\nsim_data <- read.csv(\"data/simulated_summary_statistics.csv\")\n\n# look at the first few columns\nhead(sim_data)\n\n# look at the models\nunique(sim_data$m)\n```\n\nThis data set has 27 metrics used in our paper to measure patterns in the distribution of species, such as range size metrics, or correlations between temperature and diversity, as well as phylogenetic tree shape metrics, such as gamma, and measures of functional diversity, like body size variance. We predicted that these different models of evolution (M0-M4) should leave discernible signatures in these metrics. We can plot a few associations between biodiversity metrics and these model parameters to test this hypothesis.\n\n```{r}\nrequire(ggplot2)\n\n# how is diversity related to the dispersal ability of a clade?\nggplot(sim_data, aes(x=m, y=log(n_extant_diversity), fill=m))+\n  geom_point(alpha=0.7, position = \"jitter\")+\n  geom_boxplot(alpha=0.7)+\n  stat_smooth()+\n  theme_classic()\n\n# how about the temperature~diversity gradient?\nggplot(sim_data, aes(x=m, y=richness_temp0mya_cor, fill=m))+\n  geom_point(alpha=0.7, position = \"jitter\")+\n  geom_boxplot(alpha=0.7)+\n  stat_smooth()+\n  theme_classic()\n\n# how about the relationship between  body size and diversification rate?\nggplot(sim_data, aes(x=m, y=bodysize_DR_cor, fill=m))+\n  geom_point(alpha=0.7, position = \"jitter\")+\n  geom_boxplot(alpha=0.7)+\n  stat_smooth()+\n  theme_classic()\n\n# how about the relationship between temperature and diversification rate?\nggplot(sim_data, aes(x=m, y=temp_DR_cor, fill=m))+\n  geom_point(alpha=0.7, position = \"jitter\")+\n  geom_boxplot(alpha=0.7)+\n  stat_smooth()+\n  theme_classic()\n```\n\nDo these patterns fit our predictions? We can also look at how some of these metrics varied with the continuous model parameters such as dispersal ability.\n\n```{r}\n# how is diversity related to the dispersal ability of a clade?\nggplot(sim_data, aes(x=dispersal, y=log(n_extant_diversity)))+\n  geom_point(alpha=0.7)+\n  stat_smooth()+\n  theme_classic()\n\n# how about the latitude diversity gradient?\nggplot(sim_data, aes(x=dispersal, y=temp_DR_cor))+\n  geom_point(alpha=0.7)+\n  stat_smooth()+\n  theme_classic()\n```\n\nTo perform a simple kind of sensitivity test we might ask how each of the model parameters predicts linear changes in the distribution of a biodiversity patterns using a multiple regression model. One example where we have a good idea of what the relationship should be is the how variance in the distribution of temperature niches across species (e.g., skewness of the distribution) relates to model paramaters. We expect that this should scale with the rate of rate of temperature niche evolution - faster rates of change = more variation in the trait = more kutosis.\n\n```{r}\n\n# first scale parameters to be in the same units\nsim_data_scaled <- sim_data\nsim_data_scaled[,1:6] <- scale(sim_data_scaled[,1:6] )\n\n# fit the multiple regression\nlm1  <- lm(temp_kurtosis ~ divergence_threshold+lambda+omega+sigma_squared_bs+sigma_squared_t+dispersal, data=sim_data_scaled)\n\n# look at model coefficients\nsummary(lm1)\n```\n\nWhat do you see? Are our expectations met? Any surprises? Let's try a few other biodiversity patterns where the predictions are less clear.\n\n```{r}\n# fit the multiple regressions\n\n# Gamma statsitic for phylogenetic tree shape\nlm2  <- lm(gamma ~ divergence_threshold+lambda+omega+sigma_squared_bs+sigma_squared_t+dispersal, data=sim_data_scaled)\n\n# skewness of the range size distribution of species\nlm3  <- lm(rs_skewness ~ divergence_threshold+lambda+omega+sigma_squared_bs+sigma_squared_t+dispersal, data=sim_data_scaled)\n\n# correlation between species range sizes and temperature\nlm4  <- lm(rangesize_temp_cor ~ divergence_threshold+lambda+omega+sigma_squared_bs+sigma_squared_t+dispersal, data=sim_data_scaled)\n\n# look at model coefficients\nsummary(lm2)\nsummary(lm3)\nsummary(lm4)\n```\n\nIn all these cases there are interesting associations between model parameters and the biodiversity metrics. However, look at the R-squared values and what do you find? They are highly variable and in some cases quite low. This means that lots of variance in these biodiversity metrics are not explained by a linear combination of our model parameters. This is important when interpreting the effect. There are other ways of inferring more complex relationships between model parameters and biodiversity metrics, such as by including quadratic effects, exploring interaction terms, fitting non-linear models such as generalised additive models (GAMs), or even using machine learning methods such as neural networks which allow for highly-dimension non-linear effects. We won't cover these today but they are all useful options to explore during sensitivity analysis.\n\n### Model Selection\n\nOnce we have established that some biodiversity metrics showed predictable relationships with model parameters or the generative model (e.g., M0-M4) we can use these metrics to perform model selection on empirical data. Here we are using the match between observed biodiversity patterns and simulated biodiversity patterns, to ask which model might be most likely to have generated the real patterns.\n\n![Skeels et al. 2022 Syst. Biol. Figure 2](figures/systbiol_fig2.jpeg)\n\nTo do this we are going to perform a linear discriminant analysis which is a classification tool that can fit fit fairly quickly compared to some of the other models. We want to validate how well the model performs so we will perform a 10-fold cross validation repeated 10 times. Here we train the model on a subset of the data, repeating the process and optimising the predictive capacity. Then we predict how good a job our classifier is on a witheld portion of the data (test data). If the model performs well we should be able to accurately predict what models generated what biodiversity metrics.\n\n```{r}\nrequire(caret)\n# get just the biodiversity metrics\nsim_data_ms <- sim_data[,7:ncol(sim_data)]\n\n# remove MRDs variables from sim data\nsim_data_ms <- sim_data_ms[, -which(grepl(\"MRDs\",colnames(sim_data_ms)))]\n\n# partition into a training and testing dataset for cross validation\ntrain_index <- createDataPartition(sim_data_ms$m, p = .66, list = FALSE,  times = 1)\ntrain_data <- sim_data_ms[ train_index ,]\ntest_data  <- sim_data_ms[-train_index ,]\n\n# preprocess values - we will scale and center values\npreprocessed_values <- preProcess(train_data, method = c(\"center\", \"scale\"))\ntrain_transformed   <- predict(preprocessed_values, train_data)\ntest_transformed    <- predict(preprocessed_values, test_data )\n\n# configure the cross-validation paramaters\ntrain_control <- trainControl( method = \"repeatedcv\", number = 10, repeats = 10, classProbs = TRUE, savePredictions = TRUE)\n\n# FIT MODELS\nf1 <- formula(paste(\"m ~ \", paste(names(sim_data_ms)[2:c(length(names(sim_data_ms)))], collapse=\" + \")))\n\n## LINEAR DISCRIMINANT ANALYSIS\n# note we'll run an LDA because they're quick - many other kinds of models to choose from \nlda_train        <- train(f1, data=train_transformed, method = \"lda\", trControl = train_control, verbose = T)\n\n#predict on test data\nlda_test        <- predict(lda_train, test_transformed)\n\n# classification accuracy\nlda_cm        <- confusionMatrix(data = lda_test, reference = as.factor(test_transformed$m), mode = \"prec_recall\")\n\n# how well did the model perform\nlda_cm \n\n```\n\nWhats the overall accuracy? Are some models predicted better than others?\n\nNow we'll use this model to predict the possible model of diversification in orders of terrestrial vertebrates.\n\n```{r, eval=TRUE}\n# first subset and clean the colnames of the empirical data\nempirical_data <- read.csv(\"data/order_empirical_summary_statistics.csv\")\n\n# just want to look at diverse clades\nempirical_data <- na.omit(empirical_data[which(empirical_data$n_species >= 20),])\n\n# make labels lower case\nempirical_data$taxon <- tolower(empirical_data$taxon)\n\n# clean up a few names because I'm a grub\ncolnames(empirical_data)[which(colnames(empirical_data) == \"taxon\")] <- \"m\"\ncolnames(empirical_data)[which(colnames(empirical_data)==\"rs_kutosis\")] <- \"rs_kurtosis\"\ncolnames(empirical_data)[which(colnames(empirical_data)==\"n_species\")] <- \"n_extant_diversity\"\ncolnames(empirical_data) <- gsub(\"_p_cor\", \"_cor\",colnames(empirical_data)) # change _p_cor for posterior samplescould also change _m_cor to use MCC samples\ncolnames(empirical_data) <- gsub(\"DivRate\", \"DR\",colnames(empirical_data))\ncolnames(empirical_data)[which(colnames(empirical_data) == \"taxon\")] <- \"m\"\ncolnames(empirical_data)[which(colnames(empirical_data) == \"collessI_posterior\")] <- \"collessI\"\ncolnames(empirical_data)[which(colnames(empirical_data) == \"sackinI_mcc\")] <- \"sackinI\"\ncolnames(empirical_data)[which(colnames(empirical_data) == \"gamma_mcc\")] <- \"gamma\"\n\n\n# ok these should be able to be matched now\nempirical_data <- empirical_data[, which(colnames(empirical_data) %in% colnames(sim_data_ms))]\nempirical_subset <- empirical_data[, match(colnames(sim_data_ms), colnames(empirical_data))]\n\n# check names match\ncolnames(sim_data_ms)[which(!colnames(sim_data_ms) %in% colnames(empirical_subset))]\ncolnames(empirical_subset)[which(!colnames(empirical_subset) %in% colnames(sim_data_ms))]\ncolnames(empirical_subset) == colnames(sim_data_ms)\n\n# Process empirical data in the same way as for the simulated data\nsimulated_transformed <- predict(preprocessed_values, sim_data_ms )\nempirical_transformed <- predict(preprocessed_values, empirical_subset )\n\nmodel_set <- list(lda_train)\n\n# predict on empirical\nclass_predictions   <- predict(model_set, newdata = empirical_transformed, type = \"raw\", na.action = na.omit)\nclass_probabilities <- predict(model_set, newdata = empirical_transformed, type = \"prob\", na.action = na.omit)\n\n# sum the classes\ncolSums(do.call(rbind, class_predictions)) # TODO define class prediction table\n\n# now we can see which model is the most supported for each order\ncbind(empirical_transformed$m, as.character(class_predictions[[1]]))\n\ntable(class_predictions[[1]])\n\n# can also look at the variation in this\ncbind(empirical_transformed$m, round(class_probabilities[[1]], 3))\n```\n\nWhat patterns do you see? Which models are the most supported?\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","output-file":"Day2_Prac4_outputs.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.4.551","bibliography":["references.bib"],"editor":"visual","theme":"cosmo","title":"üñ•Ô∏è Silicodiversity","author":"Alex Skeels and Oskar Hagen"},"extensions":{"book":{"multiFile":true}}},"pdf":{"identifier":{"display-name":"PDF","target-format":"pdf","base-format":"pdf"},"execute":{"fig-width":5.5,"fig-height":3.5,"fig-format":"pdf","fig-dpi":300,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"pdf","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":true,"merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"pdf-engine":"xelatex","standalone":true,"variables":{"graphics":true,"tables":true},"default-image-extension":"pdf","to":"pdf","output-file":"Day2_Prac4_outputs.pdf"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words"},"metadata":{"block-headings":true,"bibliography":["references.bib"],"editor":"visual","documentclass":"scrreprt","title":"üñ•Ô∏è Silicodiversity","author":"Alex Skeels and Oskar Hagen"},"extensions":{"book":{"selfContainedOutput":true}}},"epub":{"identifier":{"display-name":"ePub","target-format":"epub","base-format":"epub"},"execute":{"fig-width":5,"fig-height":4,"fig-format":"png","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"epub","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":true,"merge-includes":false,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"default-image-extension":"png","html-math-method":"mathml","to":"epub","output-file":"Day2_Prac4_outputs.epub"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words"},"metadata":{"bibliography":["references.bib"],"editor":"visual","cover-image":"cover.png","title":"üñ•Ô∏è Silicodiversity","author":"Alex Skeels and Oskar Hagen"},"extensions":{"book":{"selfContainedOutput":true}}}},"projectFormats":["html","pdf","epub"]}