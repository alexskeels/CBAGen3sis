{
  "hash": "2b7d657d719fb78e072e56281ec1c7a3",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"üñ•Ô∏è Silicodiversiy üåàt\"\nauthor: \"Alex Skeels and Oskar Hagen\"\nexecute: \n  eval: FALSE\n---\n\n\n## Exploring outputs {.unnumbered}\n\nIn this prac we will explore the files outputted from gen3sis using the island simulations we ran yesterday. We will learn how to manipule/wrange these data structures into formats used by common R packages for phylogenetic comparative methods, community phylogenetics, biogeography, etc.\n\nThe goal for today will be to produce:\n\n1.  A map of Species Richness from the simulation summary object\n\n2.  A plot of Lineages Through Time from the phylogeny\n\n3.  Plot of species trait values on a phylogenetic tree, by linking the species objects to the phylogeny\n\n4.  Maps of Phylogenetic Diversity by linking species objects to the landscape and phylogeny\n\nFirst, let's make sure we have the necessary packages loaded\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrequire(gen3sis)\nrequire(terra)\nrequire(ape)\nrequire(phytools)\nrequire(picante)\n```\n:::\n\n\n#### Simulation summary object (sgen3sis.rds) {.unnumbered}\n\nThe first object we will look at today is the sgenesis.rds file. This file contains a summary of the simulation. Which we can plot (as we did yesterday) with the plot_summary function.\n\n\n::: {.cell}\n\n```{.r .cell-code}\noutput_dir <- \"output/islands\" \n\nsim <- readRDS(file.path(output_dir, \"config_islands_simple_Day1Prac3_M1/sgen3sis.rds\")) \n\n# look at what the simulation summary contains\nnames(sim) \n```\n:::\n\n\nThe first element is the sim summary. This conatins a record of the history of speciation, extinction, and species richness through time (phylo_summary), a history of the number of total grid cells occupied during the simulation through time (occupancy) and the species richness of each grid cell at the final time step.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstr(sim$summary)\n\n# phylo summary\nhead(sim$summary$phylo_summary)\n\n# occupancy\nhead(sim$summary$occupancy)\n\n# occupancy\nhead(sim$summary$`richness-final`)\n```\n:::\n\n\nThese data are called on in the plot_summary function\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Visualize the outputs \nplot_summary(sim) \n```\n:::\n\n\nWe can also use these data to map out patterns of species richness\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# make sure the landscape is loaded\nlc <- readRDS(file.path(\"data\", \"landscapes\", \"islands\",\"landscapes.rds\"))\n\n# can remove cells with elevation below sea level at timestep 0 (present-day) to see the outlines of the islands\nna_mask <- is.na(lc$elevation[,\"0\"])\nrich <- sim$summary$`richness-final`\nrich[na_mask,3] <- NA\n\n# turn richness summary into a raster \nrichness <- rast(rich, type=\"xyz\")\n\n# plot\nplot(richness, col=c(\"grey\", gen3sis::color_richness(12)))\n```\n:::\n\n\nThe next part of the simulation summary object is the flag which will tell us if the simulation ran successfully. It should give \"OK\"\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsim$flag\n```\n:::\n\n\nNext is the system summary. This is information about the R version, R packages, and operating system used in the simulation. This ensures complete repeatability. It also tells us the runtime of the simulation.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsim$system\n```\n:::\n\n\nFinally the summary object contains the config infromation and model parameters used.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsim$parameters\n```\n:::\n\n\n#### Phylogeny object (phy.nex) {.unnumbered}\n\nThe phylogeny object is pretty straight forward. It is a newxus file containing the relationships between the species.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# read phy\nphy <- read.nexus(file.path(output_dir, \"config_islands_simple_Day1Prac3_M1/phy.nex\"))\n\n# plot phy\nplot(phy)\n```\n:::\n\n\nFrom this object we can look at lineages through time plots and estimate trends in diversification, such as using the gamma statistic to detect diversification slowdowns or speedups.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# plot an ltt\nltt_M1 <-ltt(phy)\n\n# look at the gamma statistic\nprint(paste0(\"Gamma = \", round(ltt_M1$gamma, 2)))\n\n# is there a significant deviation from conatant rates?\nprint(paste0(\"P = \", round(ltt_M1$p, 2)))\n```\n:::\n\n\n#### Species objects (phy.nex) {.unnumbered}\n\nNow its time to get into the meat of the gen3sis outputs. Most of the infromation from the simulation is stored in the species objects. These are .rds files that contain a list which includes information on every species, extinct or extant, that existed during the simulation. We saved these at every time step. The naming convention is \"species_t_0.rds\" for time step 0 (present-day), and \"species_t_50\" for timestep 50, etc.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# load object\nspecies_t_0 <- readRDS(file.path(output_dir, \"config_islands_simple_Day1Prac3_M1\", \"species\", \"species_t_0.rds\"))\n\n# look at object class and length\nclass(species_t_0)\nlength(species_t_0)\n\n# compare to number of tips in the phylogeny\nNtip(phy)\n```\n:::\n\n\nWe can see there are 14 elements in the list, representing our 14 species and this number matches the number of species in our phylogeny. No species went extinct in this particular simulation, but if they did, they would match extinct tips in the phylogeny.\n\nLets look at a single species\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnames(species_t_0[[1]])\n```\n:::\n\n\nThe species has an ID which allows us to match it to the phylogeny.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nspecies_t_0[[1]]$id\n```\n:::\n\n\nThe species also has its abundances, which are linked to grid cells in the landscape which can matched with their names.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nspecies_t_0[[1]]$abundance\n```\n:::\n\n\nIn this case the species has abundance values of 1 in all populations from the cells that it occupies. Thyis is because we set abundances to be binary: 1=present, 0=absent. We can see the species occupies cells 2767,2768,2769, etc.\n\nThe species also has values of it's traits for each of those populations.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhead(species_t_0[[1]]$traits)\n```\n:::\n\n\nWe can see the population that each row is linked to by the rownames. Here you can see 2767, 2768, 2769, etc. These each have a dispersal trait of 5 (because we didn;t vary this) slightly different temp_mean traits (because these evolved stochastically under a Brownian motion like model) and a temp width of 1 (again, we didn;t vary this in model 1).\n\nSo, if we want to map out the distribution of species 1 at timestep 0, we just need to link those cell names (267/268/etc) to the landscape object and make a raster. Why don;t we try and see what islands species 1 is found on.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npar(mfrow=c(1,2))\n\n# first plot the sialnds out from the landscape objet\npatch_xyz <- rast(lc$patch[,c(\"x\", \"y\", \"0\")], type=\"xyz\")\nplot(patch_xyz, main=\"Island Patches\", col=palette()[c(2,3,4,6)])\n\n# pull out values of the landscape where the species is found\nspecies1_xyz <- lc$patch[which(rownames(lc$patch) %in% rownames(species_t_0[[1]]$traits)), c(\"x\", \"y\", \"0\")]\n\n# turn it into a raster\nspecies1_xyz <- rast(species1_xyz, type=\"xyz\")\nspecies1_xyz <- extend(species1_xyz, patch_xyz)\nplot(species1_xyz, main= \"Species 1 Distribution\")\n```\n:::\n\n\n#### Linking the species object and phylogeny {.unnumbered}\n\nLets try and link the species trait data to the phylogeny to start learning something about what exactly took place during our simulation! Let's get the mean trait value of the temperature niche and also the islands that each species belongs too.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# lets create a data frame\ndf <- data.frame(\"id\"= paste0(\"species\",sapply(species_t_0, function(x)x$id)),\n                 \"mean_temp\"=NA,\n                 \"island1\"=0,\n                 \"island2\"=0,\n                 \"island3\"=0,\n                 \"island4\"=0, \n                 \"island_start\"=NA)\n\n# take a look\nhead(df)\n\n# Use sapply on the species object to get their mean trait values\ndf$mean_temp <- sapply(species_t_0, function(x)mean(x$traits[, \"temp_mean\"], na.rm=T))\n\n# to get the island patch id values we'll use a for loop\nfor(i in 1:length(species_t_0)){\n  \n  # as before we get the lanscape values of each species\n  speciesi_xyz <- lc$patch[which(rownames(lc$patch) %in% rownames(species_t_0[[i]]$traits)), c(\"x\", \"y\", \"0\")]\n  \n  # then pull out the unique values (note that species might occur on more than one island)\n  islands <- unique(speciesi_xyz[, 3])\n  \n  # then if species are on the island, give that column a value of 1\n  df$island1[i] <- ifelse(1 %in% islands, 1, 0)\n  df$island2[i] <- ifelse(2 %in% islands, 1, 0)\n  df$island3[i] <- ifelse(3 %in% islands, 1, 0)\n  df$island4[i] <- ifelse(4 %in% islands, 1, 0)\n}\n\n# get the starting island from the traits object because we recorded this in the initialisation step\ndf$island_start <- sapply(species_t_0, function(x) unique(x$traits[, \"start_island\"]))\n```\n:::\n\n\nNow look again at the data frame\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhead(df)\n```\n:::\n\n\nPlot out the continuously evolving temperature niche trait\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# create a named vector for the log of the temperature niche trait\ntemp_niche <- log(df$mean_temp)\nnames(temp_niche) <- df$id\n\n# plot it out with dots = trait\ndotTree(phy,temp_niche,ftype=\"i\")\n```\n:::\n\n\nNot much variation in that trait, due to the combined effects of trait homogenisation and a low rate of change. Lets plot the tip states of the islands on the phylogeny using the phytools package\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# format each island\nformatIsland <- function(island, phy=phy){\n  islandf <- as.factor(df[, island])\n  names(islandf) <- df$id\n  islandmat<-to.matrix(islandf,levels(islandf))\n  islandmat<-islandmat[phy$tip.label,]\n  return(list(islandf, islandmat))\n}\n\n\nplotTree(phy,ftype=\"i\",offset=1,fsize=0.9, xlim=c(0, 75))\n\ntiplabels(pie=formatIsland(island=\"island1\", phy=phy)[[2]],piecol=palette()[c(8,2)],cex=0.6, adj=12+1)\ntiplabels(pie=formatIsland(island=\"island2\", phy=phy)[[2]],piecol=palette()[c(8,3)],cex=0.6, adj=12+3)\ntiplabels(pie=formatIsland(island=\"island3\", phy=phy)[[2]],piecol=palette()[c(8,4)],cex=0.6, adj=12+5)\ntiplabels(pie=formatIsland(island=\"island4\", phy=phy)[[2]],piecol=palette()[c(8,6)],cex=0.6, adj=12+7)\n\n\nlegend(\"topleft\",levels(island1),pch=21,pt.bg=palette()[c(8,2)],\n    pt.cex=2.2)\n```\n:::\n\n\nInteresting. What do you notice about the distribution of species on islands? Could you predict which island each lineage began on?\n\nWe actually know which islands each lineage started on because we recorded this as a trait (we could also look at the past species objects to figure this out but we have used a short cut method).\n\n\n::: {.cell}\n\n```{.r .cell-code}\npar(mfrow=c(1,2))\nplotTree(phy,ftype=\"i\",offset=1,fsize=0.4, xlim=c(0, 75))\n\ntiplabels(pie=formatIsland(island=\"island1\", phy=phy)[[2]],piecol=palette()[c(8,2)],cex=0.6, adj=12+1)\ntiplabels(pie=formatIsland(island=\"island2\", phy=phy)[[2]],piecol=palette()[c(8,3)],cex=0.6, adj=12+3)\ntiplabels(pie=formatIsland(island=\"island3\", phy=phy)[[2]],piecol=palette()[c(8,4)],cex=0.6, adj=12+5)\ntiplabels(pie=formatIsland(island=\"island4\", phy=phy)[[2]],piecol=palette()[c(8,6)],cex=0.6, adj=12+7)\n# add the starting island as a fifth colum\ntiplabels(pie=formatIsland(island=\"island_start\", phy=phy)[[2]],piecol=palette()[c(2,3,4,6)],cex=0.6, adj=12+9)\n\n# add island plot\nplot(patch_xyz, main=\"Island Patches\", col=palette()[c(2,3,4,6)])\n```\n:::\n\n\nSo whats really apparent here is that the clade that originated on the green island has speciated allopatrically into the red island multiple times in the recent past. The same is true fro the red clade, however the deeper divergence between species9 and species3 have had enough time to recolonise both islands.\n\n#### Linking the species object, landscape, and phylogeny\n\nCommon spatial biodiversity analyses link information measured at the species level to maps of their distribution in space using presence-absence matrices or PAMs. PAMs typically are data frame with each row representing a site, could be an island or could be a grid cell, and each column representing a species. Values of 1 are given if the species is present in the site, if not a value of 0 is given.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# grid cell level PAM\n\n# create an empty data frame with the dimensions of species x sites\nPAM <- data.frame(matrix(0, nrow=nrow(lc$elevation), ncol=length(species_t_0)))\n\n# given names to rows and columns\nrownames(PAM) <- rownames(lc$elevation)\ncolnames(PAM) <- paste0(\"species\", sapply(species_t_0, function(x)x$id))\n\n# loop over species and add value of 1 to all sites the species is present\nfor(i in 1:length(species_t_0)){\n  \n  PAM[which(rownames(PAM) %in% names(species_t_0[[i]]$abundance)), i] <- 1\n}\n\n# how does it look?\nprint(PAM[1:10, 1:10])\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# we can estimate Phylogenetic diversity\npd_islands <- pd(PAM, phy)\n\n# we can also measure mean phylogenetic distance and mean nearest neighbour distance\nmpd_islands <- mpd(PAM, cophenetic(phy))\nmntd_islands <- mntd(PAM,cophenetic(phy))\n\n# link these back back with the landscape by joining to the lanscape lat/lons\ncommunity_phylo <- cbind(lc$elevation[, c(\"x\", \"y\")], pd_islands, mpd_islands, mntd_islands)\n\npar(mfrow=c(2,2))\nsr_ras <- rast(community_phylo[, c(\"x\", \"y\", \"SR\")], type=\"xyz\")\npd_ras <- rast(community_phylo[, c(\"x\", \"y\", \"PD\")], type=\"xyz\")\nmpd_ras <- rast(community_phylo[, c(\"x\", \"y\", \"mpd_islands\")], type=\"xyz\")\nmntd_ras <- rast(community_phylo[, c(\"x\", \"y\", \"mntd_islands\")], type=\"xyz\")\n\nplot(sr_ras, main=\"Species Richness\")\nplot(pd_ras, main=\"Phylogenetic Diversity\")\nplot(mpd_ras, main=\"Mean Phylogenetic Pairwise Distance\")\nplot(mntd_ras, main= \"Mean Nearest Neighbour Phylogenetic Distance\")\n```\n:::\n\n\n## Sensitivity analysis {.unnumbered}\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}